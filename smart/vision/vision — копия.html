<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="../" />
  <title>–ü—É—Ç—å –ø–æ –≤–∏–∑–∏–∏</title>
  <link rel="icon" href="assets/logo400.jpg" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="vision/vision.css" />


 <!--
    üß† –ì–ª–æ–±–∞–ª—å–Ω—ã–π bootstrap –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –∫—ç—à–µ–º.
    1) –ü—Ä–æ–±—É–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫—ç—à –∏–∑ localStorage (–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è UI)
    2) –í —Ñ–æ–Ω–µ –¥—ë—Ä–≥–∞–µ—Ç /api/auth/session, –æ–±–Ω–æ–≤–ª—è–µ—Ç window.SV_AUTH –∏ –∫—ç—à
    3) –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö –∫—É–∫–∏ sv_session (—Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã)
  -->
  <script>
    (function () {
      const AUTH_CACHE_KEY = 'sv.auth.cache.v1';

      // –ë–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –≥–æ—Å—Ç—å
      window.SV_AUTH = {
        isAuthenticated: false,
        userId: null,
        level: 1,
        levelCode: 'guest',
        email: null,
        displayName: null,
        loaded: false
      };

      function normalizeSession(data) {
        data = data || {};
        const isAuth = !!data.is_authenticated;
        let level = Number(data.level);
        if (!Number.isFinite(level) || level <= 0) {
          level = isAuth ? 2 : 1;
        }
        const levelCode = data.level_code || (level === 1 ? 'guest' : 'user');

        return {
          isAuthenticated: isAuth,
          userId: data.user_id ?? null,
          level: level,
          levelCode: levelCode,
          email: data.email ?? null,
          displayName: data.display_name ?? null,
          loaded: true
        };
      }

      function dispatchAuthReady() {
        try {
          document.dispatchEvent(
            new CustomEvent('sv:auth-ready', { detail: window.SV_AUTH })
          );
        } catch (e) {
          console.warn('sv:auth-ready dispatch failed', e);
        }
      }

      function readCache() {
        try {
          const raw = localStorage.getItem(AUTH_CACHE_KEY);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') return null;
          return parsed;
        } catch (e) {
          return null;
        }
      }

      function writeCache(session) {
        try {
          localStorage.setItem(AUTH_CACHE_KEY, JSON.stringify(session));
        } catch (e) {
          // localStorage –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        }
      }

      // 1) –ü—ã—Ç–∞–µ–º—Å—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø–æ–¥–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –∫—ç—à–∞
      (function hydrateFromCache() {
        const cached = readCache();
        if (!cached) return;
        // –°—á–∏—Ç–∞–µ–º –∫—ç—à —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º SV_AUTH
        window.SV_AUTH = Object.assign({}, cached, { loaded: true });
        dispatchAuthReady();
      })();

      // 2) –í —Ñ–æ–Ω–µ —Ç—è–Ω–µ–º —Å–≤–µ–∂—É—é —Å–µ—Å—Å–∏—é —Å –±—ç–∫–µ–Ω–¥–∞
      fetch('/api/auth/session', {
        method: 'GET',
        credentials: 'include'
      })
        .then(function (res) {
          if (!res.ok) throw new Error('Auth check failed');
          return res.json();
        })
        .then(function (data) {
          const session = normalizeSession(data);
          window.SV_AUTH = session;
          writeCache(session);
          dispatchAuthReady();
        })
        .catch(function (err) {
          console.warn('Auth bootstrap failed', err);
          // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ –±—ã–ª–æ –∏ –º—ã –≤—Å—ë –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚Äî –æ—Å—Ç–∞—ë–º—Å—è –≥–æ—Å—Ç–µ–º
          if (!window.SV_AUTH.loaded) {
            const guest = normalizeSession({});
            window.SV_AUTH = guest;
            writeCache(guest);
            dispatchAuthReady();
          }
        });
    })();
  </script>

  <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ø–±–∞—Ä–∞/–º–µ–Ω—é –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ -->
  <script type="module">
    import { initPage } from './js/topbar.module.js';
    initPage({
      fragments: [['menu.html', '#sidebar']],
      cacheBust: false,
      topbar: { state: { logoHref: 'index.html', logoSrc: 'assets/logo400.jpg' } }
    });
  </script>
  
</head>







<body>
  <div id="page">
    <aside id="sidebar" aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é"></aside>
    <div id="app">
      <header id="topbar" role="banner"></header>

    <main id="main" role="main">
      <section class="vision-page">




        <div class="vision-panel">
  <!-- –ë–õ–û–ö 1: –ú–æ–∏ –≤–∏–∑–∏–∏ -->
  <section class="vision-list-block">
    <h2 class="vision-title">–ú–æ–∏ –≤–∏–∑–∏–∏</h2>

    <div class="vision-list-header">
      <button id="newVisionBtn" type="button" class="vision-btn vision-btn-secondary">
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–∏–∑–∏—é
      </button>
    </div>

    <div id="visionList" class="vision-list"></div>
  </section>

  <!-- –ë–õ–û–ö 2: –ü—É—Ç—å –ø–æ –≤–∏–∑–∏–∏ (—á–∞—Ç) -->
  <section class="vision-chat-block">
    <!-- 1 —Å—Ç—Ä–æ–∫–∞: –ü–£–¢–¨ –ü–û –í–ò–ó–ò–ò -->
    <h1 class="vision-title-main">–ü–£–¢–¨ –ü–û –í–ò–ó–ò–ò</h1>

    <!-- 2 —Å—Ç—Ä–æ–∫–∞: –ù–ê–ó–í–ê–ù–ò–ï –í–ò–ó–ò–ò | –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å -->
    <div class="vision-chat-title-row">
      <div id="visionTitle" class="vision-title-current">
        –í—ã–±–µ—Ä–∏ –≤–∏–∑–∏—é –∏–ª–∏ —Å–æ–∑–¥–∞–π –Ω–æ–≤—É—é
      </div>
      <div class="vision-title-actions">
        <button
          id="renameVisionBtn"
          type="button"
          class="vision-rename-link"
          disabled
        >
          –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
        </button>
      </div>
    </div>

    <!-- 3+ —Å—Ç—Ä–æ–∫–∏: –¥–∏–∞–ª–æ–≥ -->
    <div id="messages" class="vision-messages"></div>

    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ (–≤–Ω–∏–∑—É) -->
    <form id="messageForm" class="vision-form">
      <textarea
        id="userInput"
        class="vision-input"
        rows="3"
        placeholder="–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —à–∞–≥ –∫ —Å–≤–æ–µ–π –≤–∏–∑–∏–∏..."
        disabled
      ></textarea>
      <button type="submit" id="sendBtn" class="vision-btn" disabled>
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
      </button>
    </form>

    <div id="visionError" class="vision-error vision-hidden"></div>
  </section>
</div>


      </section>
    </main>



       <div id="home-geo-footer"></div>
      <footer id="footer" role="contentinfo"></footer>
    </div>
  </div>
   <div id="overlay" hidden></div>

<script defer src="js/footer.js?v=2"></script>

<!-- PROD-–í–ê–†–ò–ê–ù–¢ (–æ—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)
<script type="module">
  import { requireLevel } from "./js/guards.js";
  import "./vision/vision.js";
  requireLevel({ level: 2 });
</script>
-->

<!-- DEV-–í–ê–†–ò–ê–ù–¢ –î–õ–Ø –õ–û–ö–ê–õ–ö–ò -->
<script type="module">
  import "./vision/vision.js";
  // –Ω–∏–∫–∞–∫–æ–π guards.js, —á–∏—Å—Ç—ã–π –¥–∏–∑–∞–π–Ω
</script>



</body>
</html>
