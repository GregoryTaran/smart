<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="../" />
  <title>Мои визии</title>
  <link rel="icon" href="assets/logo400.jpg" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="vision/vision.css" />

  <!-- Авторизация (как в оригинале) -->
  <script>
    /* полностью копирую bootstrap auth как в vision.html */
    (function () {
      const AUTH_CACHE_KEY = 'sv.auth.cache.v1';

      window.SV_AUTH = {
        isAuthenticated: false,
        userId: null,
        level: 1,
        levelCode: 'guest',
        email: null,
        displayName: null,
        loaded: false
      };

      function normalizeSession(data) {
        data = data || {};
        const isAuth = !!data.is_authenticated;
        let level = Number(data.level);
        if (!Number.isFinite(level) || level <= 0) {
          level = isAuth ? 2 : 1;
        }
        const levelCode = data.level_code || (level === 1 ? 'guest' : 'user');

        return {
          isAuthenticated: isAuth,
          userId: data.user_id ?? null,
          level,
          levelCode,
          email: data.email ?? null,
          displayName: data.display_name ?? null,
          loaded: true
        };
      }

      function dispatchAuthReady() {
        document.dispatchEvent(
          new CustomEvent('sv:auth-ready', { detail: window.SV_AUTH })
        );
      }

      function readCache() {
        try {
          const raw = localStorage.getItem(AUTH_CACHE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }

      function writeCache(session) {
        try {
          localStorage.setItem(AUTH_CACHE_KEY, JSON.stringify(session));
        } catch {}
      }

      (function hydrate() {
        const cached = readCache();
        if (cached) {
          window.SV_AUTH = cached;
          dispatchAuthReady();
        }
      })();

      fetch('/api/auth/session', { credentials: 'include' })
        .then(r => r.json())
        .then(d => {
          const s = normalizeSession(d);
          window.SV_AUTH = s;
          writeCache(s);
          dispatchAuthReady();
        })
        .catch(() => dispatchAuthReady());
    })();
  </script>

  <!-- topbar & sidebar -->
  <script type="module">
    import { initPage } from './js/topbar.module.js';
    initPage({
      fragments: [['menu.html', '#sidebar']],
      cacheBust: false,
      topbar: { state: { logoHref: 'index.html', logoSrc: 'assets/logo400.jpg' } }
    });
  </script>
</head>

<body>
  <div id="page">
    <aside id="sidebar"></aside>

    <div id="app">
      <header id="topbar"></header>

      <main id="main">
        <section class="vision-page">

          <div class="vision-panel">

            <section class="vision-list-block">
              <h2 class="vision-title">Мои визии</h2>

              <div class="vision-list-header">
                <button id="newVisionBtn" class="vision-btn vision-btn-secondary">
                  Создать новую визию
                </button>
              </div>

              <div id="visionList" class="vision-list"></div>
            </section>

          </div>

        </section>
      </main>

      <footer id="footer"></footer>
    </div>
  </div>

  <script defer src="js/footer.js?v=2"></script>

  <!-- JS для списка визий -->
  <script type="module" src="vision/vision_list.js"></script>
</body>
</html>
