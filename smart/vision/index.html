<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="../" />
  <title>Мои визии</title>
  <link rel="icon" href="assets/logo400.jpg" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="vision/vision.css" />

  <!-- Авторизация (как в оригинале) -->
 <script>
(function () {
  const AUTH_CACHE_KEY='sv.auth.cache.v1';

  window.SV_AUTH={
    isAuthenticated:false,
    userId:null,
    email:null,
    displayName:null,
    level:1,
    levelCode:'guest',
    loaded:false,
    _resolve:null,
    ready:null
  };

  window.SV_AUTH.ready=new Promise(resolve=>window.SV_AUTH._resolve=resolve);

  async function bootstrap(){
    try{
      const cached=localStorage.getItem(AUTH_CACHE_KEY);
      if(cached) Object.assign(SV_AUTH,JSON.parse(cached));

      const resp=await fetch("/api/auth/me",{method:"GET",credentials:"include"});
      const data=await resp.json();

      if(data.loggedIn){
        const u=data.user_merged||{};
        SV_AUTH.isAuthenticated=true;
        SV_AUTH.userId=u.id||null;
        SV_AUTH.email=u.email||null;
        SV_AUTH.displayName=u.name||null;
        SV_AUTH.level=data.level||2;
        SV_AUTH.levelCode=data.level_code||"user";
      }else{
        SV_AUTH.isAuthenticated=false;
        SV_AUTH.userId=null;
        SV_AUTH.level=1;
        SV_AUTH.levelCode='guest';
      }

      localStorage.setItem(AUTH_CACHE_KEY,JSON.stringify(SV_AUTH));
    }catch(e){ console.warn(e); }

    SV_AUTH.loaded=true;
    SV_AUTH._resolve(SV_AUTH);
  }
  bootstrap();
})();
</script>

  <!-- topbar & sidebar -->
  <script type="module">
    import { initPage } from './js/topbar.module.js';
    initPage({
      fragments: [['menu.html', '#sidebar']],
      cacheBust: false,
      topbar: { state: { logoHref: 'index.html', logoSrc: 'assets/logo400.jpg' } }
    });
  </script>
</head>

<body>
  <div id="page">
    <aside id="sidebar"></aside>

    <div id="app">
      <header id="topbar"></header>

      <main id="main">
        <section class="vision-page">

          <div class="vision-panel">

            <section class="vision-list-block">
              <h2 class="vision-title">Мои визии</h2>

              <div class="vision-list-header">
                <button id="newVisionBtn" class="vision-btn vision-btn-secondary">
                  Создать новую визию
                </button>
              </div>

              <div id="visionList" class="vision-list"></div>
            </section>

          </div>

        </section>
      </main>

      <footer id="footer"></footer>
    </div>
  </div>

  <script defer src="js/footer.js?v=2"></script>

  <!-- JS для списка визий -->
  <script type="module" src="vision/vision_list.js"></script>
</body>
</html>
