<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="../" />
  <title>Путь по визии</title>
  <link rel="icon" href="assets/logo400.jpg" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="vision/vision.css" />

  <script>
    (function () {
      // Значения по умолчанию: гость
      window.SV_AUTH = {
        isAuthenticated: false,
        userId: null,
        level: 1,
        levelCode: 'guest',
        email: null,
        displayName: null,
        loaded: false
      };

      function applySession(data) {
        window.SV_AUTH.isAuthenticated = !!data.is_authenticated;
        window.SV_AUTH.userId = data.user_id ?? null;
        window.SV_AUTH.level = data.level ?? 1;
        window.SV_AUTH.levelCode =
          data.level_code || (window.SV_AUTH.level === 1 ? 'guest' : 'user');
        window.SV_AUTH.email = data.email ?? null;
        window.SV_AUTH.displayName = data.display_name ?? null;
        window.SV_AUTH.loaded = true;

        // Сообщаем всем, что авторизация прогружена
        document.dispatchEvent(
          new CustomEvent('sv:auth-ready', { detail: window.SV_AUTH })
        );
      }

      // Тянем сессию с бэка
      fetch('/api/auth/session', {
        method: 'GET',
        credentials: 'include'
      })
        .then(function (res) {
          if (!res.ok) throw new Error('Auth check failed');
          return res.json();
        })
        .then(applySession)
        .catch(function () {
          // В случае ошибки остаёмся гостем
          applySession({});
        });
    })();
  </script>

    <!-- наш модуль топбара -->
  <script type="module">
    import { initPage } from "./js/topbar.module.js";
    initPage({
      fragments: [["menu.html", "#sidebar"]],
      cacheBust: false,
      topbar: {
        state: { logoHref: "index.html", logoSrc: "assets/logo400.jpg", auth: { user: null } }
      }
    });
  </script>
</head>







<body>
  <div id="page">
    <aside id="sidebar" aria-label="Основное меню"></aside>
    <div id="app">
      <header id="topbar" role="banner"></header>

    <main id="main" role="main">
      <section class="vision-page">




        <div class="vision-panel">
  <!-- БЛОК 1: Мои визии -->
  <section class="vision-list-block">
    <h2 class="vision-title">Мои визии</h2>

    <div class="vision-list-header">
      <button id="newVisionBtn" type="button" class="vision-btn vision-btn-secondary">
        Создать новую визию
      </button>
    </div>

    <div id="visionList" class="vision-list"></div>
  </section>

  <!-- БЛОК 2: Путь по визии (чат) -->
  <section class="vision-chat-block">
    <!-- 1 строка: ПУТЬ ПО ВИЗИИ -->
    <h1 class="vision-title-main">ПУТЬ ПО ВИЗИИ</h1>

    <!-- 2 строка: НАЗВАНИЕ ВИЗИИ | Переименовать -->
    <div class="vision-chat-title-row">
      <div id="visionTitle" class="vision-title-current">
        Выбери визию или создай новую
      </div>
      <div class="vision-title-actions">
        <button
          id="renameVisionBtn"
          type="button"
          class="vision-rename-link"
          disabled
        >
          Переименовать
        </button>
      </div>
    </div>

    <!-- 3+ строки: диалог -->
    <div id="messages" class="vision-messages"></div>

    <!-- Поле ввода (внизу) -->
    <form id="messageForm" class="vision-form">
      <textarea
        id="userInput"
        class="vision-input"
        rows="3"
        placeholder="Сформулируй шаг к своей визии..."
        disabled
      ></textarea>
      <button type="submit" id="sendBtn" class="vision-btn" disabled>
        Отправить
      </button>
    </form>

    <div id="visionError" class="vision-error vision-hidden"></div>
  </section>
</div>


      </section>
    </main>



       <div id="home-geo-footer"></div>
      <footer id="footer" role="contentinfo"></footer>
    </div>
  </div>
   <div id="overlay" hidden></div>

<script defer src="js/footer.js?v=2"></script>

<!-- PROD-ВАРИАНТ (оставляем в комментарии)
<script type="module">
  import { requireLevel } from "./js/guards.js";
  import "./vision/vision.js";
  requireLevel({ level: 2 });
</script>
-->

<!-- DEV-ВАРИАНТ ДЛЯ ЛОКАЛКИ -->
<script type="module">
  import "./vision/vision.js";
  // никакой guards.js, чистый дизайн
</script>



</body>
</html>
