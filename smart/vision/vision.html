<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="../" />
  <title>Путь по визии</title>
  <link rel="icon" href="assets/logo400.jpg" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="vision/vision.css" />

  <!-- Авторизация — идентичная той же -->
  <script>
    /* тот же bootstrap auth, что в index.html */
    (function () {
      const AUTH_CACHE_KEY = 'sv.auth.cache.v1';

      window.SV_AUTH = {
        isAuthenticated: false,
        userId: null,
        level: 1,
        levelCode: 'guest',
        email: null,
        displayName: null,
        loaded: false
      };

      function normalizeSession(data) {
        data = data || {};
        const isAuth = !!data.is_authenticated;
        let level = Number(data.level);
        if (!Number.isFinite(level) || level <= 0) {
          level = isAuth ? 2 : 1;
        }
        const levelCode = data.level_code || (level === 1 ? 'guest' : 'user');

        return {
          isAuthenticated: isAuth,
          userId: data.user_id ?? null,
          level,
          levelCode,
          email: data.email ?? null,
          displayName: data.display_name ?? null,
          loaded: true
        };
      }

      function dispatchAuthReady() {
        document.dispatchEvent(
          new CustomEvent('sv:auth-ready', { detail: window.SV_AUTH })
        );
      }

      function readCache() {
        try {
          const raw = localStorage.getItem(AUTH_CACHE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch { return null; }
      }

      function writeCache(session) {
        try {
          localStorage.setItem(AUTH_CACHE_KEY, JSON.stringify(session));
        } catch {}
      }

      (function hydrate() {
        const cached = readCache();
        if (cached) {
          window.SV_AUTH = cached;
          dispatchAuthReady();
        }
      })();

      fetch('/api/auth/session', { credentials: 'include' })
        .then(r => r.json())
        .then(d => {
          const s = normalizeSession(d);
          window.SV_AUTH = s;
          writeCache(s);
          dispatchAuthReady();
        })
        .catch(() => dispatchAuthReady());
    })();
  </script>

  <!-- topbar & sidebar -->
  <script type="module">
    import { initPage } from './js/topbar.module.js';
    initPage({
      fragments: [['menu.html', '#sidebar']],
      cacheBust: false,
      topbar: { state: { logoHref: 'index.html', logoSrc: 'assets/logo400.jpg' } }
    });
  </script>
</head>

<body>
  <div id="page">
    <aside id="sidebar"></aside>

    <div id="app">
      <header id="topbar"></header>

      <main id="main">
        <section class="vision-page">
          <div class="vision-panel">

            <section class="vision-chat-block">

                <button
                  onclick="window.location.href = '/vision/index.html'"
                  class="vision-btn vision-btn-secondary">
                  ← Назад
                </button>


              <h1 class="vision-title-main">ПУТЬ ПО ВИЗИИ</h1>

              <div class="vision-chat-title-row">
                <div id="visionTitle" class="vision-title-current">
                  Загрузка...
                </div>
                <div class="vision-title-actions">
                  <button id="renameVisionBtn" class="vision-rename-link" disabled>
                    Переименовать
                  </button>
                </div>
              </div>

              <div id="messages" class="vision-messages"></div>

              <form id="messageForm" class="vision-form">
                <textarea id="userInput" class="vision-input" rows="3"
                  placeholder="Введите шаг..."></textarea>
                <button type="submit" id="sendBtn" class="vision-btn">
                  Отправить
                </button>
              </form>

              <div id="visionError" class="vision-error vision-hidden"></div>

            </section>

          </div>
        </section>
      </main>

      <footer id="footer"></footer>
    </div>
  </div>

  <script defer src="js/footer.js?v=2"></script>

  <!-- JS для конкретной визии -->
  <script type="module" src="vision/vision.js"></script>
</body>
</html>
