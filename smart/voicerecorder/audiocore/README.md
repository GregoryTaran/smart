# AudioCore ‚Äî –∑–∞—Ö–≤–∞—Ç, –Ω–∞—Ä–µ–∑–∫–∞ –∏ —Å–±–æ—Ä–∫–∞ –∞—É–¥–∏–æ (Web Audio API)

–≠—Ç–æ—Ç –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç ¬´—Å–µ—Ä–¥—Ü–µ¬ª –∑–≤—É–∫–æ–≤–æ–≥–æ —Å—Ç–µ–∫–∞: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –±–∞–∑–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É (–≥–µ–π–Ω, AEC/NS/AGC ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), –ø–µ—Ä–µ–¥–∞—á—É PCM-–∫–∞–¥—Ä–æ–≤ —á–µ—Ä–µ–∑ AudioWorklet, –Ω–∞—Ä–µ–∑–∫—É –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã –∏ —Å–±–æ—Ä–∫—É –∏—Ç–æ–≥–æ–≤–æ–≥–æ WAV.

## üìÅ –°–æ—Å—Ç–∞–≤ –∫–∞—Ç–∞–ª–æ–≥–∞

```
audiocore/
‚îú‚îÄ sv-audio-core.js      # –Ø–¥—Ä–æ –∑–∞—Ö–≤–∞—Ç–∞: MediaStream ‚Üí GainNode ‚Üí AudioWorklet
‚îú‚îÄ recorder.worklet.js   # AudioWorkletProcessor: –æ—Ç–¥–∞—ë—Ç Float32 –∫–∞–¥—Ä—ã –≤ –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫
‚îú‚îÄ wav-segmenter.js      # –†–µ–∂–µ—Ç –ø–æ—Ç–æ–∫ –Ω–∞ —Ä–æ–≤–Ω—ã–µ 2s —Å–µ–≥–º–µ–Ω—Ç—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–π –º–æ–∂–Ω–æ –¥–æ–ø–∞–¥–∏—Ç—å —Ç–∏—à–∏–Ω–æ–π)
‚îî‚îÄ wav-assembler.js      # –°–∫–ª–µ–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π WAV (–æ–ø—Ü. —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥)
```

## üîå –û–±—â–∏–π –ø–æ—Ç–æ–∫ —Å–∏–≥–Ω–∞–ª–∞

```
[ getUserMedia ]
      ‚îÇ  (–ø—Ä–∏–º–µ–Ω—è–µ–º AEC/NS/AGC ‚Äî —Ñ–ª–∞–≥–∏ –∏–∑ sv-audio-core.js)
      ‚ñº
MediaStreamSource ‚îÄ‚îÄ‚ñ∫ GainNode(VR_MANUAL_GAIN) ‚îÄ‚îÄ‚ñ∫ AudioWorkletNode("recorder-processor")
                                               (port.postMessage ‚Üí Float32 –∫–∞–¥—Ä—ã)
      ‚ñº
  (–≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫)
      ‚ñº
WavSegmenter (2s –∫—É—Å–∫–∏ Int16 + meta) ‚îÄ‚îÄ‚ñ∫ WavAssembler (–±–æ–ª—å—à–æ–π WAV –ø–æ –∑–∞–ø—Ä–æ—Å—É)
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞—Ö–≤–∞—Ç–∞ (sv-audio-core.js)

–í–µ—Ä—Ö —Ñ–∞–π–ª–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–ª–∞–≥–∏ ‚Äî ¬´–æ–¥–Ω–∞ —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã¬ª –¥–ª—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ —Ç—Ä–∞–∫–∞:

```js
// =================== VoiceRecorder audio defaults (edit here) ===================
const VR_ECHO_CANCELLATION = false;  // Acoustic Echo Cancellation (AEC)
const VR_NOISE_SUPPRESSION = false;  // Noise Suppression (NS)
const VR_AUTO_GAIN_CONTROL = false;  // Auto Gain Control (AGC)
const VR_MANUAL_GAIN      = 1.3;     // –†—É—á–Ω–æ–π –≥–µ–π–Ω —á–µ—Ä–µ–∑ GainNode (1.0 = –±–µ–∑ —É—Å–∏–ª–µ–Ω–∏—è)
// ===============================================================================
```

- **AEC/NS/AGC** –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ `MediaStreamTrack.applyConstraints()` –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è, –µ—Å–ª–∏ –¥–µ–≤–∞–π—Å/–±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç.
- **VR_MANUAL_GAIN** –∑–∞–¥–∞—ë—Ç ¬´—á–µ—Å—Ç–Ω–æ–µ¬ª –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ –Ω–∞ `GainNode` (–≤–ª–∏—è–µ—Ç –∏ –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –∏ –Ω–∞ –∑–∞–ø–∏—Å—å).

### –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–æ–≤
- üì± –ú–æ–±–∏–ª—å–Ω–∞—è —Ä–µ—á—å (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å): `AGC=false`, `GAIN=1.2‚Äì1.4`, `AEC=false`, `NS=false`.
- üñ•Ô∏è –ù–æ—É—Ç —Å —ç—Ö–æ–º/—à—É–º–æ–º: `AEC=true`, `NS=true`, `AGC=false`, `GAIN=1.1‚Äì1.3`.
- üß™ –¢–µ—Å—Ç ¬´–∫–∞–∫ –µ—Å—Ç—å¬ª: –≤—Å—ë `false`, `GAIN=1.0`.

## üß± API —è–¥—Ä–∞ (sv-audio-core.js)

```js
const core = new SVAudioCore(options?);

// –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª
await core.init();        // –∑–∞–ø—É—Å–∫–∞–µ—Ç AudioContext, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω, —Å—Ç—Ä–æ–∏—Ç –≥—Ä–∞—Ñ, –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–ª–∞–≥–∏
core.stop();              // —Å—Ç–æ–ø –≥—Ä–∞—Ñ–∞ –∏ —Å—Ç—Ä–∏–º–∞
core.destroy();           // –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

// –ü–∞—É–∑–∞/—Ä–µ–∑—é–º
core.pauseCapture();
core.resumeCapture();

// –î–æ—Å—Ç—É–ø –∫ –æ–∫—Ä—É–∂–µ–Ω–∏—é
const ctx    = core.getContext();  // AudioContext
const stream = core.getStream();   // MediaStream (–ø–æ—Å–ª–µ Gain/Worklet)

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞–¥—Ä–æ–≤
core.onAudioFrame = (float32MonoFrame) => { /* –≤–∞—à –∫–æ–¥ */ };
```

> **–í–∞–∂–Ω–æ:** –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫ `core.getStream()` ‚Äî –æ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —É–∂–µ **—É—Å–∏–ª–µ–Ω–Ω—ã–π** —Å–∏–≥–Ω–∞–ª.

## üß© AudioWorklet (recorder.worklet.js)

- –û–±—ä—è–≤–ª—è–µ—Ç `registerProcessor('recorder-processor', class extends AudioWorkletProcessor { ... })`.
- –í `process(inputs)` –±–µ—Ä—ë—Ç –∏–∑ `inputs[0][0]` **–º–æ–Ω–æ Float32** –±–ª–æ–∫ (–æ–±—ã—á–Ω–æ 128 —Å–µ–º–ø–ª–æ–≤), –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–∏–∫—à–∏—Ä—É–µ—Ç –≤ –º–æ–Ω–æ, –∏ —à–ª—ë—Ç –≤ –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ `this.port.postMessage({ type: 'frame', data: Float32Array })`.
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: Worklet —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∞—É–¥–∏–æ-–ø–æ—Ç–æ–∫–µ, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –ª–∞–≥–∏ –∏ –¥–∂–∏—Ç—Ç–µ—Ä.

## ‚úÇÔ∏è –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è (wav-segmenter.js)

–ó–∞–¥–∞—á–∞: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫ –≤ **—Ä–æ–≤–Ω—ã–µ 2s —Å–µ–≥–º–µ–Ω—Ç—ã** (–¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä).

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ü—Ä–∏ –ø–æ—Ç–æ–∫–µ –∏–∑ Worklet —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ¬´—Ö–≤–æ—Å—Ç¬ª. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è `2s`, —ç–º–∏—Ç–∏—Ç —Å–µ–≥–º–µ–Ω—Ç (`pcmInt16`, `sampleRate`, `durationSec`, `seq`).
- –ù–∞ `stop()` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–¥–≤–∞ —Ä–µ–∂–∏–º–∞**:  
  - `padLastSegment: true` ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç –¥–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è **–Ω—É–ª—è–º–∏** –¥–æ 2s (—É–¥–æ–±–Ω–æ –¥–ª—è —Ä–æ–≤–Ω–æ–π —Å–µ—Ç–∫–∏),  
  - `padLastSegment: false` ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç —ç–º–∏—Ç–∏—Ç—Å—è ¬´–∫–∞–∫ –µ—Å—Ç—å¬ª (–∫–æ—Ä–æ—á–µ 2s).
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –æ—Ç–¥–∞–≤–∞—Ç—å `blob` (WAV –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç), –µ—Å–ª–∏ `emitBlobPerSegment = true`.

–ü—Ä–∏–º–µ—Ä:
```js
import WavSegmenter from './wav-segmenter.js';

const seg = new WavSegmenter({
  sampleRate: audioCtx.sampleRate,
  segmentSeconds: 2,
  normalize: true,
  normalizeTarget: 0.99,
  padLastSegment: true,      // –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—Å–µ–≥–¥–∞ —Ä–æ–≤–Ω–æ 2s (—Ö–≤–æ—Å—Ç + —Ç–∏—à–∏–Ω–∞)
  emitBlobPerSegment: false, // –µ—Å–ª–∏ –Ω—É–∂–µ–Ω WAV per —Å–µ–≥–º–µ–Ω—Ç, –ø–æ—Å—Ç–∞–≤—å—Ç–µ true
});

seg.onSegment = (s) => {
  // s: { seq, sampleRate, durationSec, pcmInt16, blob|null }
  // –∑–¥–µ—Å—å —É–¥–æ–±–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ–≥–º–µ–Ω—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
};
```

## üßµ –°–±–æ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ WAV (wav-assembler.js)

–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç—ã (–∏–∑ Segmenter) –∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É —Å–æ–±–∏—Ä–∞–µ—Ç **–±–æ–ª—å—à–æ–π WAV**.  
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –°–∫–ª–µ–π–∫–∞ `Int16` –º–∞—Å—Å–∏–≤–æ–≤ –≤—Å–µ—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–ø–æ –ø–æ—Ä—è–¥–∫—É `seq`).
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π **—Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥** –≤ `targetSampleRate` (–ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è; –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –¥–∏–∫—Ç–æ–≤–∫–∏ –∏ ASR).
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Blob` (`audio/wav`).

–ü—Ä–∏–º–µ—Ä:
```js
import WavAssembler from './wav-assembler.js';

const asm = new WavAssembler({ /* targetSampleRate: 16000 */ });

segments.forEach(s => asm.addSegment(s));

const wavBlob = asm.buildFinalWav();
// –°–∫–∞—á–∞—Ç—å –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã (voicerecorder.js)

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫:
```js
// 1) –ó–∞—Ö–≤–∞—Ç
await core.init();
const sr = core.getContext().sampleRate;

// 2) –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è
const segments = [];
const seg = new WavSegmenter({ sampleRate: sr, segmentSeconds: 2, padLastSegment: true });
core.onAudioFrame = (f32) => seg.pushFrame(f32);
seg.onSegment = (s) => segments.push(s);

// 3) –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ Stop
seg.stop(); // —ç–º–∏—Ç–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π (–ø–∞–¥–¥–µ–¥) —Å–µ–≥–º–µ–Ω—Ç
const asm = new WavAssembler();
segments.forEach(s => asm.addSegment(s));
const bigWav = asm.buildFinalWav();
```

## üì± –ó–∞–º–µ—á–∞–Ω–∏—è –ø–æ –º–æ–±–∏–ª—å–Ω—ã–º –±—Ä–∞—É–∑–µ—Ä–∞–º

- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ–≤–∞–π—Å—ã —á–∞—Å—Ç–∏—á–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç –∑–∞–ø—Ä–µ—Ç AGC/NS/AEC ‚Äî –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∑–∞–ø–∏—Å—å —É—à–∞–º–∏.  
- –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —á–∞—Å—Ç–æ –ª—É—á—à–µ: `AGC=false`, `GAIN=1.2‚Äì1.4`.  
- –ï—Å–ª–∏ —Å–ª—ã—à–µ–Ω ¬´—Ö—Ä–∏–ø¬ª/–∫–ª–∏–ø–ø–∏–Ω–≥ ‚Äî —Å–Ω–∏–∑—å—Ç–µ `VR_MANUAL_GAIN` –Ω–∞ 0.1‚Äì0.2.

## ‚ö° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **AudioWorklet** (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) ‚Äî `ScriptProcessorNode` —É—Å—Ç–∞—Ä–µ–ª.  
- –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ/—É–Ω–∏—á—Ç–æ–∂–∞–π—Ç–µ –æ–±—ä–µ–∫—Ç—ã —á–∞—Å—Ç–æ –≤ —Ä–µ–Ω–¥–µ—Ä-—Ü–∏–∫–ª–µ; –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—É—Ñ–µ—Ä—ã.  
- –î–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —É–º–µ–Ω—å—à–∞–π—Ç–µ `smoothingTimeConstant` –¥–æ 0.2‚Äì0.3, –∞ `fftSize` –¥–µ—Ä–∂–∏—Ç–µ 1024‚Äì2048.

## üß™ –û—Ç–ª–∞–¥–∫–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π `sampleRate`: `core.getContext().sampleRate` (–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö —á–∞—Å—Ç–æ 48000).  
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `stopBtn.disabled = false` —Å—Ç–∞–≤–∏—Ç—Å—è **–ø–æ—Å–ª–µ** —É—Å–ø–µ—à–Ω–æ–≥–æ `core.init()`.  
- –ï—Å–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π WAV 1‚Äì2 –ö–ë: –≤—ã –Ω–∞–∂–∞–ª–∏ Stop –¥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–∞ –∏ –Ω–µ –≤–∫–ª—é—á–∏–ª–∏ `padLastSegment`. –í–∫–ª—é—á–∏—Ç–µ `padLastSegment: true` –∏–ª–∏ –∂–º–∏—Ç–µ Stop –ø–æ—Å–ª–µ 2s.

## üß∞ –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

- [ ] `VR_AUTO_GAIN_CONTROL = false` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ –∑–≤—É—á–∞–Ω–∏–µ).  
- [ ] `VR_MANUAL_GAIN` –ø–æ–¥–æ–±—Ä–∞–Ω (1.2‚Äì1.4).  
- [ ] `padLastSegment = true` (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤).  
- [ ] HTTPS –≤–∫–ª—é—á—ë–Ω (–∏–Ω–∞—á–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –º–æ–∂–µ—Ç –Ω–µ –¥–∞–≤–∞—Ç—å—Å—è).  
- [ ] –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω (–∫–∞—á–µ—Å—Ç–≤–æ/–≥—Ä–æ–º–∫–æ—Å—Ç—å/–∫–ª–∏–ø–ø–∏–Ω–≥).

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è
MIT
