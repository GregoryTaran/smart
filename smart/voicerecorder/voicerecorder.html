<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<base href="../" />
<title>Диктофон</title>
<link rel="icon" href="assets/logo400.jpg" />
<link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="css/main.css" />
<link rel="stylesheet" href="voicerecorder/mic-indicator/mic-indicator.css" />
<link rel="stylesheet" href="voicerecorder/voicerecorder.css" />

  <script>
    (function () {
      // Значения по умолчанию: гость
      window.SV_AUTH = {
        isAuthenticated: false,
        userId: null,
        level: 1,
        levelCode: 'guest',
        email: null,
        displayName: null,
        loaded: false
      };

      function applySession(data) {
        window.SV_AUTH.isAuthenticated = !!data.is_authenticated;
        window.SV_AUTH.userId = data.user_id ?? null;
        window.SV_AUTH.level = data.level ?? 1;
        window.SV_AUTH.levelCode =
          data.level_code || (window.SV_AUTH.level === 1 ? 'guest' : 'user');
        window.SV_AUTH.email = data.email ?? null;
        window.SV_AUTH.displayName = data.display_name ?? null;
        window.SV_AUTH.loaded = true;

        // Сообщаем всем, что авторизация прогружена
        document.dispatchEvent(
          new CustomEvent('sv:auth-ready', { detail: window.SV_AUTH })
        );
      }

      // Тянем сессию с бэка
      fetch('/api/auth/session', {
        method: 'GET',
        credentials: 'include'
      })
        .then(function (res) {
          if (!res.ok) throw new Error('Auth check failed');
          return res.json();
        })
        .then(applySession)
        .catch(function () {
          // В случае ошибки остаёмся гостем
          applySession({});
        });
    })();
  </script>



</head>
<body>
<div id="page">
  <aside id="sidebar" aria-label="Основное меню"></aside>
  <div id="app">
    <header id="topbar" role="banner"></header>
    <main id="main" role="main">

<section class="vr-root">
  <div class="vr-container sv-center-700">
    <div class="demo">
      <h3>Mic Indicator — тест (Start / Pause / Stop)</h3>

      <!-- ВАЖНО: правильный контейнер для индикатора -->
      <div aria-hidden="true" class="mic-box">
        <div id="vc-level"></div>
      </div>

      <div class="controls">
        <button id="startBtn">Start</button>
        <button id="pauseBtn" disabled>Pause</button>
        <button id="stopBtn" disabled>Stop</button>

        <audio id="sv-player" class="sv-player sv-player--disabled" controls preload="metadata"></audio>

        <span class="status" id="status">idle</span>

        <ul id="record-list" style="margin-top:1em;font-family:monospace;"></ul>
      </div>
    </div>
  </div>
</section>

    </main>
    <footer id="footer" role="contentinfo"></footer>
  </div>
</div>

<div id="overlay" hidden></div>

<script defer src="svid/svid.js"></script>
<script defer src="js/footer.js?v=2"></script>

<!-- Мягкое получение разрешения на микрофон -->
<script type="module">
  const statusEl = document.getElementById('status');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn  = document.getElementById('stopBtn');

  const setStatus = (text) => { if (statusEl) statusEl.textContent = text; };

  async function requestMicOnce() {
    try {
      if (navigator.permissions?.query) {
        try {
          const perm = await navigator.permissions.query({ name: 'microphone' });
          if (perm.state === 'granted') { setStatus('microphone: granted'); return true; }
          if (perm.state === 'denied')  { setStatus('microphone: denied');  return false; }
        } catch {}
      }
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
      });
      stream.getTracks().forEach(t => t.stop());
      setStatus('microphone: granted');
      startBtn?.removeAttribute('disabled');
      return true;
    } catch (e) {
      console.error('getUserMedia error:', e);
      setStatus(`microphone: ${e?.name || 'error'}`);
      startBtn?.setAttribute('disabled', 'true');
      pauseBtn?.setAttribute('disabled', 'true');
      stopBtn?.setAttribute('disabled', 'true');
      return false;
    }
  }

  document.addEventListener('DOMContentLoaded', () => { requestMicOnce(); });
</script>

<!-- Основной модуль диктофона -->
<script defer type="module" src="voicerecorder/voicerecorder.js"></script>

<script type="module">
  import { initPage } from "./js/topbar.module.js";
  initPage({
    fragments: [["menu.html", "#sidebar"]],
    cacheBust: false,
    topbar: {
      state: { logoHref: "index.html", logoSrc: "assets/logo400.jpg", auth: { user: null } }
    }
  });
</script>
</body>
</html>
