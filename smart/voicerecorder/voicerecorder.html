<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<base href="../" />
<title>Ð”Ð¸ÐºÑ‚Ð¾Ñ„Ð¾Ð½</title>

<link rel="icon" href="assets/logo400.jpg" />
<link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="css/main.css" />
<link rel="stylesheet" href="voicerecorder/mic-indicator/mic-indicator.css" />
<link rel="stylesheet" href="voicerecorder/voicerecorder.css" />

<script>
  (function () {
    const AUTH_CACHE_KEY = 'sv.auth.cache.v1';

    window.SV_AUTH = {
      isAuthenticated: false,
      userId: null,
      level: 1,
      levelCode: 'guest',
      email: null,
      displayName: null,
      loaded: false
    };

    function norm(data) {
      data = data || {};
      const isAuth = !!data.is_authenticated;
      let level = Number(data.level);
      if (!Number.isFinite(level) || level <= 0) level = isAuth ? 2 : 1;
      return {
        isAuthenticated: isAuth,
        userId: data.user_id ?? null,
        level,
        levelCode: data.level_code || (level === 1 ? 'guest' : 'user'),
        email: data.email ?? null,
        displayName: data.display_name ?? null,
        loaded: true
      };
    }

    function dispatch() {
      document.dispatchEvent(new CustomEvent('sv:auth-ready', { detail: window.SV_AUTH }));
    }

    function read() {
      try {
        const raw = localStorage.getItem(AUTH_CACHE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function write(x) {
      try { localStorage.setItem(AUTH_CACHE_KEY, JSON.stringify(x)); } catch {}
    }

    // 1) Ð˜Ð· ÐºÑÑˆÐ° Ð¼Ð³Ð½Ð¾Ð²ÐµÐ½Ð½Ð¾
    (function () {
      const c = read();
      if (!c) return;
      window.SV_AUTH = Object.assign({}, c, { loaded: true });
      dispatch();
    })();

    // 2) Ð’ Ñ„Ð¾Ð½Ðµ Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°
    fetch('/api/auth/session', { credentials: 'include' })
      .then(r => r.json())
      .then(d => {
        const s = norm(d);
        window.SV_AUTH = s;
        write(s);
        dispatch();
      })
      .catch(() => dispatch());
  })();
</script>

<script type="module">
  import { initPage } from './js/topbar.module.js';
  initPage({
    fragments: [['menu.html', '#sidebar']],
    cacheBust: false,
    topbar: { state: { logoHref: 'index.html', logoSrc: 'assets/logo400.jpg' } }
  });
</script>
</head>

<body>
<div id="page">
  <aside id="sidebar"></aside>

  <div id="app">
    <header id="topbar"></header>

    <main id="main">

      <!-- ðŸŽ¤ Ð•Ð”Ð˜ÐÐÐ¯ ÐšÐÐ Ð¢ÐžÐ§ÐšÐ Ð”Ð›Ð¯ Ð”Ð˜ÐšÐ¢ÐžÐ¤ÐžÐÐ -->
      <section class="card">
        <h2 class="card-title">Ð”Ð¸ÐºÑ‚Ð¾Ñ„Ð¾Ð½</h2>

        <div class="mic-box" aria-hidden="true">
          <div id="vc-level"></div>
        </div>

        <div class="controls">
          <button id="startBtn" class="btn-purple">Start</button>
          <button id="pauseBtn" class="btn-purple" disabled>Pause</button>
          <button id="stopBtn" class="btn-purple" disabled>Stop</button>
        </div>

        <audio id="sv-player" class="sv-player sv-player--disabled" controls preload="metadata"></audio>

        <div class="status" id="status" style="margin-top:10px;">idle</div>

        <ul id="record-list" style="margin-top:1em;font-family:monospace;"></ul>
      </section>

    </main>

    <footer id="footer"></footer>
  </div>
</div>

<div id="overlay" hidden></div>

<script type="module">
  import { requireLevel } from "./js/guards.js";
  import "./voicerecorder/voicerecorder.js";
  requireLevel({ level: 2 });
</script>

<script type="module">
  // ÐœÑÐ³ÐºÐ¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð½Ð° Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½
  const statusEl = document.getElementById('status');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn  = document.getElementById('stopBtn');

  const setStatus = (text) => { if (statusEl) statusEl.textContent = text; };

  async function requestMicOnce() {
    try {
      if (navigator.permissions?.query) {
        try {
          const perm = await navigator.permissions.query({ name: 'microphone' });
          if (perm.state === 'granted') { setStatus('microphone: granted'); return true; }
          if (perm.state === 'denied')  { setStatus('microphone: denied'); return false; }
        } catch {}
      }
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
      });
      stream.getTracks().forEach(t => t.stop());
      setStatus('microphone: granted');
      startBtn?.removeAttribute('disabled');
      return true;
    } catch (e) {
      console.error('getUserMedia error:', e);
      setStatus(`microphone: ${e?.name || 'error'}`);
      startBtn?.setAttribute('disabled', 'true');
      pauseBtn?.setAttribute('disabled', 'true');
      stopBtn?.setAttribute('disabled', 'true');
      return false;
    }
  }

  document.addEventListener('DOMContentLoaded', () => { requestMicOnce(); });
</script>

<script defer src="js/footer.js?v=2"></script>
</body>
</html>
