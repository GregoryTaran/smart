<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="../" />
  <title>Установка SMART VISION для Android</title>

  <link rel="icon" href="assets/logo400.jpg" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="app/app.css" />


 <script>
  (function () {
    const AUTH_CACHE_KEY = 'sv.auth.cache.v1';
    window.SV_AUTH = { isAuthenticated:false, userId:null, email:null, displayName:null, level:1, levelCode:'guest', loaded:false, _resolve:null, ready:null };
    window.SV_AUTH.ready = new Promise(resolve => window.SV_AUTH._resolve = resolve);

    async function bootstrap() {
      try {
        const cached = localStorage.getItem(AUTH_CACHE_KEY);
        if (cached) Object.assign(window.SV_AUTH, JSON.parse(cached));

        const resp = await fetch("/api/auth/me", { method:"GET", credentials:"include" });
        const data = await resp.json();

        if (data.loggedIn) {
          const u = data.user_merged || {};
          SV_AUTH.isAuthenticated = true;
          SV_AUTH.userId = u.id || null;
          SV_AUTH.email = u.email || null;
          SV_AUTH.displayName = u.name || null;
          SV_AUTH.level = data.level || 2;
          SV_AUTH.levelCode = data.level_code || "user";
        } else {
          SV_AUTH.isAuthenticated = false;
          SV_AUTH.userId = null;
          SV_AUTH.level = 1;
          SV_AUTH.levelCode = "guest";
        }

        localStorage.setItem(AUTH_CACHE_KEY, JSON.stringify(SV_AUTH));
      } catch(e){ console.warn(e); }

      SV_AUTH.loaded = true;
      SV_AUTH._resolve(SV_AUTH);
    }
    bootstrap();
  })();
  </script>

  <!-- Инициализация топбара/меню как и раньше -->
  <script type="module">
    import { initPage } from './js/topbar.module.js';
    initPage({
      fragments: [['menu.html', '#sidebar']],
      cacheBust: false,
      topbar: { state: { logoHref: 'index.html', logoSrc: 'assets/logo400.jpg' } }
    });
  </script>


</head>
<body>
  <div id="page">
    <aside id="sidebar" aria-label="Основное меню"></aside>
    <div id="app">
      <header id="topbar" role="banner"></header>
      <main id="main" role="main">
        <section class="sv-install">
          <div class="sv-center-700 sv-install__box">
            <img class="sv-install__logo" src="assets/logo400.jpg" alt="SMART VISION" height="96" />
            <p class="sv-install__lead">Установите приложение и пользуйтесь диктофоном и сервисами прямо с телефона.</p>

            <a class="sv-install__button" href="app/SmartVisionAndroid.apk" download rel="noopener">
              Установить приложение SMART VISION для Android
            </a>
            <p class="sv-install__hint">
              Если загрузка не началась, <a href="app/SmartVisionAndroid.apk" rel="noopener">нажмите здесь</a>.
            </p>

            <details class="sv-install__help">
              <summary>Как установить APK</summary>
              <ol>
                <li>Нажмите «Установить» и дождитесь загрузки файла <code>SmartVisionAndroid.apk</code>.</li>
                <li>Откройте файл в «Загрузках» на телефоне.</li>
                <li>Если система попросит — разрешите установку из этого источника.</li>
                <li>Подтвердите установку и дождитесь завершения.</li>
              </ol>
            </details>
          </div>
        </section>
      </main>
      <footer id="footer" role="contentinfo"></footer>
    </div>
  </div>

  <div id="overlay" hidden></div>

  <!-- общие скрипты -->
  
  <script defer src="js/footer.js?v=2"></script>
  <!-- <script defer src="js/register-sw.js"></script> -->

  <!-- UX для Android -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.querySelector('.sv-install__button');
      if (btn && /Android/i.test(navigator.userAgent)) {
        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  </script>




</body>
</html>
