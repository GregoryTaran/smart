<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- –ë–ê–ó–ê –î–õ–Ø –í–°–ï–• –ü–£–¢–ï–ô –í–ù–£–¢–†–ò /smart -->
  <base href="../" />

  <title>SMART VISION ‚Äî –í—Ö–æ–¥ (SVID)</title>

  <link rel="icon" href="assets/logo400.jpg" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="login/login.css" />


   <!--
    üß† –ì–ª–æ–±–∞–ª—å–Ω—ã–π bootstrap –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –∫—ç—à–µ–º.
    1) –ü—Ä–æ–±—É–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫—ç—à –∏–∑ localStorage (–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è UI)
    2) –í —Ñ–æ–Ω–µ –¥—ë—Ä–≥–∞–µ—Ç /api/auth/session, –æ–±–Ω–æ–≤–ª—è–µ—Ç window.SV_AUTH –∏ –∫—ç—à
    3) –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö –∫—É–∫–∏ sv_session (—Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã)
  -->
  <script>
    (function () {
      const AUTH_CACHE_KEY = 'sv.auth.cache.v1';

      // –ë–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –≥–æ—Å—Ç—å
      window.SV_AUTH = {
        isAuthenticated: false,
        userId: null,
        level: 1,
        levelCode: 'guest',
        email: null,
        displayName: null,
        loaded: false
      };

      function normalizeSession(data) {
        data = data || {};
        const isAuth = !!data.is_authenticated;
        let level = Number(data.level);
        if (!Number.isFinite(level) || level <= 0) {
          level = isAuth ? 2 : 1;
        }
        const levelCode = data.level_code || (level === 1 ? 'guest' : 'user');

        return {
          isAuthenticated: isAuth,
          userId: data.user_id ?? null,
          level: level,
          levelCode: levelCode,
          email: data.email ?? null,
          displayName: data.display_name ?? null,
          loaded: true
        };
      }

      function dispatchAuthReady() {
        try {
          document.dispatchEvent(
            new CustomEvent('sv:auth-ready', { detail: window.SV_AUTH })
          );
        } catch (e) {
          console.warn('sv:auth-ready dispatch failed', e);
        }
      }

      function readCache() {
        try {
          const raw = localStorage.getItem(AUTH_CACHE_KEY);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') return null;
          return parsed;
        } catch (e) {
          return null;
        }
      }

      function writeCache(session) {
        try {
          localStorage.setItem(AUTH_CACHE_KEY, JSON.stringify(session));
        } catch (e) {
          // localStorage –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        }
      }

      // 1) –ü—ã—Ç–∞–µ–º—Å—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø–æ–¥–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –∫—ç—à–∞
      (function hydrateFromCache() {
        const cached = readCache();
        if (!cached) return;
        // –°—á–∏—Ç–∞–µ–º –∫—ç—à —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º SV_AUTH
        window.SV_AUTH = Object.assign({}, cached, { loaded: true });
        dispatchAuthReady();
      })();

      // 2) –í —Ñ–æ–Ω–µ —Ç—è–Ω–µ–º —Å–≤–µ–∂—É—é —Å–µ—Å—Å–∏—é —Å –±—ç–∫–µ–Ω–¥–∞
      fetch('/api/auth/session', {
        method: 'GET',
        credentials: 'include'
      })
        .then(function (res) {
          if (!res.ok) throw new Error('Auth check failed');
          return res.json();
        })
        .then(function (data) {
          const session = normalizeSession(data);
          window.SV_AUTH = session;
          writeCache(session);
          dispatchAuthReady();
        })
        .catch(function (err) {
          console.warn('Auth bootstrap failed', err);
          // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ –±—ã–ª–æ –∏ –º—ã –≤—Å—ë –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚Äî –æ—Å—Ç–∞—ë–º—Å—è –≥–æ—Å—Ç–µ–º
          if (!window.SV_AUTH.loaded) {
            const guest = normalizeSession({});
            window.SV_AUTH = guest;
            writeCache(guest);
            dispatchAuthReady();
          }
        });
    })();
  </script>

  <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ø–±–∞—Ä–∞/–º–µ–Ω—é –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ -->
  <script type="module">
    import { initPage } from './js/topbar.module.js';
    initPage({
      fragments: [['menu.html', '#sidebar']],
      cacheBust: false,
      topbar: { state: { logoHref: 'index.html', logoSrc: 'assets/logo400.jpg' } }
    });
  </script>


</head>
<body>
  <div id="page">
    <aside id="sidebar" aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é"></aside>
    <div id="app">
      <header id="topbar" role="banner"></header>

      <main id="main" role="main">
        
        
        
        
   <section class="login">
  <div class="login__box sv-center-700">
    <!-- –æ–±—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <h1 class="login__title">–í–•–û–î | –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</h1>

    <!-- –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å -->
    <div class="login__status" id="svid-status" role="status" aria-live="polite"></div>

    <!-- ===== –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ===== -->
    <form class="login__form" id="svid-form-register" data-svid-form="register" novalidate>
      <label class="login__label" for="reg-name">
        –ò–º—è
        <input
          class="login__input"
          id="reg-name"
          name="name"
          type="text"
          placeholder="–ò–º—è.."
          autocomplete="name"
          required
        />
      </label>

      <label class="login__label" for="reg-email">
        Email
        <input
          class="login__input"
          id="reg-email"
          name="email"
          type="email"
          placeholder="Email..."
          autocomplete="email"
          required
        />
      </label>

      <label class="login__label" for="reg-pass">
        –ü–∞—Ä–æ–ª—å
        <input
          class="login__input"
          id="reg-pass"
          name="password"
          type="password"
          placeholder="–ü–∞—Ä–æ–ª—å.."
          autocomplete="new-password"
          required
        />
      </label>

      <!-- –≥–ª–∞–≤–Ω–∞—è —Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ -->
      <button class="login__btn" id="btn-register" type="submit">
        –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø
      </button>

      <!-- "–∏–ª–∏" –º–µ–ª–∫–∏–º —à—Ä–∏—Ñ—Ç–æ–º -->
      <p class="micro-hint">–∏–ª–∏</p>

      <!-- –±–µ–ª–∞—è –∫–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏" -->
      <div class="login__links">
        <button
          class="login__btn login__btn--ghost"
          id="switch-to-login"
          type="button"
          data-action="to-login"
        >
          –í–û–ô–¢–ò
        </button>
      </div>
    </form>

    <!-- ===== –≠–ö–†–ê–ù –í–•–û–î–ê ===== -->
    <form class="login__form" id="svid-form-login" data-svid-form="login" hidden novalidate>
      <label class="login__label" for="login-email">
        Email
        <input
          class="login__input"
          id="login-email"
          name="email"
          type="email"
          placeholder="Email..."
          autocomplete="username"
          required
        />
      </label>

      <label class="login__label" for="login-pass">
        –ü–∞—Ä–æ–ª—å
        <input
          class="login__input"
          id="login-pass"
          name="password"
          type="password"
          placeholder="–ü–∞—Ä–æ–ª—å.."
          autocomplete="current-password"
          required
        />
      </label>

      <!-- –≥–ª–∞–≤–Ω–∞—è —Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ -->
      <button class="login__btn" id="btn-login" type="submit">
        –í–û–ô–¢–ò
      </button>

      <!-- "–∏–ª–∏" –º–µ–ª–∫–∏–º —à—Ä–∏—Ñ—Ç–æ–º -->
      <p class="micro-hint">–∏–ª–∏</p>

      <!-- –±–µ–ª—ã–µ –∫–Ω–æ–ø–∫–∏ -->
      <div class="login__links">
        <button
          class="login__btn login__btn--ghost"
          id="switch-to-register-1"
          type="button"
          data-action="to-register"
        >
          –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
        </button>

        <button
          class="login__btn login__btn--ghost"
          id="switch-to-reset-1"
          type="button"
          data-action="to-reset"
        >
          –°–ë–†–û–°–ò–¢–¨ –ü–ê–†–û–õ–¨
        </button>
      </div>
    </form>

    <!-- ===== –≠–ö–†–ê–ù –°–ë–†–û–°–ê –ü–ê–†–û–õ–Ø ===== -->
    <form class="login__form" id="svid-form-reset" data-svid-form="reset" hidden novalidate>
      <p class="login__text">–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</p>

      <label class="login__label" for="reset-email">
        Email
        <input
          class="login__input"
          id="reset-email"
          name="email"
          type="email"
          placeholder="Email..."
          autocomplete="email"
          required
        />
      </label>

      <!-- –≥–ª–∞–≤–Ω–∞—è —Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ -->
      <button class="login__btn" id="btn-reset-password" type="submit">
        –ü–û–õ–£–ß–ò–¢–¨ –ü–ê–†–û–õ–¨
      </button>

      <!-- —Ç–µ–∫—Å—Ç –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π -->
      <p class="micro-hint">
        –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –º—ã —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∏ –ø–æ–∫–∞–∂–µ–º –Ω–∏–∂–µ.
      </p>

      <!-- –±–µ–ª—ã–µ –∫–Ω–æ–ø–∫–∏ -->
      <div class="login__links">
        <button
          class="login__btn login__btn--ghost"
          id="switch-to-login-2"
          type="button"
          data-action="to-login"
        >
          –í–û–ô–¢–ò
        </button>

        <button
          class="login__btn login__btn--ghost"
          id="switch-to-register-2"
          type="button"
          data-action="to-register"
        >
          –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
        </button>
      </div>

      <!-- —Å—é–¥–∞ –≤—ã–≤–æ–¥–∏–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å -->
      <div class="login__status login__status--inline" id="reset-result" role="status" aria-live="polite"></div>
    </form>
  </div>
</section>










      </main>

      <footer id="footer" role="contentinfo"></footer>
    </div>
  </div>

  <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
  <div id="overlay" hidden></div>
  <script defer src="js/footer.js?v=2"></script>
  <script defer src="login/login.js"></script>


</body>
</html>
