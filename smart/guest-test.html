<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>SMART VISION ‚Äî Guest test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    button { padding: 10px 16px; font-size: 16px; cursor: pointer; }
    .row { margin: 14px 0; }
    pre { background: #0b1020; color: #bfe7ff; padding: 12px; border-radius: 8px; overflow:auto; }
    code { background:#f5f7fb; padding:2px 4px; border-radius:4px; }
  </style>
</head>
<body>

  <h1>SMART VISION ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Å—Ç—è (Supabase)</h1>

  <div class="row">
    <button id="btn">Create GUEST and check profile</button>
  </div>

  <div class="row">
    <strong>–õ–æ–≥–∏:</strong>
    <pre id="log">–≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É‚Ä¶</pre>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    // üëâ –¢–í–û–ò –î–ê–ù–ù–´–ï –ü–†–û–ï–ö–¢–ê
    const SUPABASE_URL = 'https://bqtlomddtojirtkazpvj.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxdGxvbWRkdG9qaXJ0a2F6cHZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NzgyODcsImV4cCI6MjA3ODI1NDI4N30.Q6c_Ehc9WmjcF5FNNT-48GGy60Rk53i3t99K5zqTSJk' // ‚¨ÖÔ∏è –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ anon key

    // === –ö–õ–ò–ï–ù–¢ ===
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // === –í–°–ü–û–ú–û–ì–ê–¢–û–†–´ ===
    const logEl = document.getElementById('log')
    const log = (title, obj) => {
      const m = `[${new Date().toLocaleTimeString()}] ${title}` +
                (obj ? ` ${JSON.stringify(obj, null, 2)}` : '')
      logEl.textContent += '\n' + m
      console.log(title, obj || '')
    }
    const rnd = () => crypto.randomUUID().replace(/-/g, '')

    // === –û–°–ù–û–í–ù–û–ô –ü–†–û–¶–ï–°–° ===
    async function run() {
      try {
        log('–ó–∞–ø—É—Å–∫–∞—é —Å–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Å—Ç—è‚Ä¶')

        // 1) —Å–æ–∑–¥–∞—ë–º –≥–æ—Å—Ç—è —Å –≤–∞–ª–∏–¥–Ω—ã–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–º email
        const email = `guest+1@example.com`
        const password = rnd()

        const { data: sign, error: signErr } = await supabase.auth.signUp({ email, password })
        if (signErr) {
          log('signUp error:', { name: signErr.name, status: signErr.status, message: signErr.message })
          log('–ü–æ–¥—Å–∫–∞–∑–∫–∞:', '–í Auth ‚Üí Settings –ø—Ä–æ–≤–µ—Ä—å Allow new users to sign up. –í Email provider –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å Confirm email –¥–ª—è dev.')
          return
        }

        const userId = sign.user?.id
        log('GUEST —Å–æ–∑–¥–∞–Ω:', { userId, email })

        // 2) –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–µ—Å—Å–∏—è)
        const { data: me } = await supabase.auth.getUser()
        log('auth.getUser():', me)

        // 3) —á–∏—Ç–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ public.profiles (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω —Ç—Ä–∏–≥–≥–µ—Ä–æ–º)
        const { data: prof, error: profErr } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .maybeSingle()

        if (profErr) {
          log('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ profiles:', { message: profErr.message })
          return
        }

        if (!prof) {
          log('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω:', '–≤–æ–∑–º–æ–∂–Ω–æ, —Ç—Ä–∏–≥–≥–µ—Ä –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ RLS/–ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.')
        } else {
          log('–ü—Ä–æ—Ñ–∏–ª—å –Ω–∞–π–¥–µ–Ω:', prof) // –æ–∂–∏–¥–∞–µ–º is_guest: true
        }

      } catch (e) {
        log('UNHANDLED ERROR:', { message: e?.message })
      }
    }

    document.getElementById('btn').addEventListener('click', run)
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script defer src="js/identity-guard.js"></script>
</body>
</html>
