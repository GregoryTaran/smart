export async function renderTranslator(mount) {
  mount.innerHTML = `
    <div style="background:#f2f2f2;border-radius:12px;padding:18px;">
      <h2>ğŸ™ï¸ ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‡Ğ¸Ğº â€” Ğ¡ÑƒÑ„Ğ»Ñ‘Ñ€</h2>

      <div style="text-align:center;margin-bottom:10px;">
        <label style="font-weight:600;">ğŸ§‘ Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ¾Ğ·Ğ²ÑƒÑ‡ĞºĞ¸:</label>
        <select id="voice-select">
          <option value="alloy">Alloy (ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹)</option>
          <option value="verse">Verse (Ğ±Ğ°Ñ€Ñ…Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ğ¼ÑƒĞ¶ÑĞºĞ¾Ğ¹)</option>
          <option value="echo">Echo (Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹ Ñ‚ĞµĞ¼Ğ±Ñ€)</option>
        </select>
      </div>

      <div style="text-align:center;margin-bottom:10px;">
        <label style="font-weight:600;">Ğ¯Ğ·Ñ‹ĞºĞ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ñ€Ğ°:</label>
        <select id="lang-pair">
          <option value="en-ru">ğŸ‡¬ğŸ‡§ EN â†” ğŸ‡·ğŸ‡º RU</option>
          <option value="es-ru">ğŸ‡ªğŸ‡¸ ES â†” ğŸ‡·ğŸ‡º RU</option>
          <option value="fr-ru">ğŸ‡«ğŸ‡· FR â†” ğŸ‡·ğŸ‡º RU</option>
          <option value="de-ru">ğŸ‡©ğŸ‡ª DE â†” ğŸ‡·ğŸ‡º RU</option>
        </select>
      </div>

      <div style="text-align:center;margin-bottom:10px;">
        <button id="translator-record-btn">Start</button>
        <button id="ctx-stop" style="background:#f44336;" disabled>Stop</button>
      </div>

      <div id="session-info" style="text-align:center;font-weight:600;color:#4caf50;margin-top:10px;"></div> <!-- ĞœĞµÑÑ‚Ğ¾ Ğ´Ğ»Ñ sessionId Ğ¿Ğ¾Ğ´ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ -->

      <div id="ctx-log" style="min-height:300px;overflow:auto;">
        <div id="session-id" style="font-weight:600;color:#4caf50;"></div> <!-- ĞœĞµÑÑ‚Ğ¾ Ğ´Ğ»Ñ sessionId Ğ² Ğ»Ğ¾Ğ³Ğµ -->
      </div>
    </div>
  `;

  const logEl = mount.querySelector("#ctx-log");
  const sessionInfoEl = mount.querySelector("#session-info"); // ĞœĞµÑÑ‚Ğ¾ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° sessionId Ğ¿Ğ¾Ğ´ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Start
  const sessionIdEl = mount.querySelector("#session-id"); // ĞœĞµÑÑ‚Ğ¾ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° sessionId Ğ² Ğ»Ğ¾Ğ³Ğµ
  const btnStart = mount.querySelector("#translator-record-btn");
  const btnStop = mount.querySelector("#ctx-stop");
  const voiceSel = mount.querySelector("#voice-select");
  const langSel = mount.querySelector("#lang-pair");

  let ws, audioCtx, stream, sessionId = null;

  const WS_URL = location.protocol === "https:" ? "wss://" + location.host : "ws://" + location.host;

  function log(msg) {
    const div = document.createElement("div");
    div.textContent = msg;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞ¶Ğµ ÑĞµÑÑĞ¸Ñ Ğ² SessionStorage Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
  function checkSession() {
    const storedSessionId = sessionStorage.getItem('sessionId');
    if (storedSessionId) {
      sessionId = storedSessionId; // Ğ•ÑĞ»Ğ¸ ÑĞµÑÑĞ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞµĞµ
      sessionInfoEl.textContent = `Session ID: ${sessionId}`;  // Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ sessionId Ğ¿Ğ¾Ğ´ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Start
      sessionIdEl.textContent = `Session ID: ${sessionId}`;  // Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ sessionId Ğ² Ğ»Ğ¾Ğ³Ğµ
      log("ğŸ“© Ğ’Ğ¾Ğ·Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° ÑĞµÑÑĞ¸Ñ: " + sessionId);
    } else {
      createSession(); // Ğ•ÑĞ»Ğ¸ ÑĞµÑÑĞ¸Ñ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ
    }
  }

  // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
  function createSession() {
    sessionId = "sess-" + Date.now();  // Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ sessionId
    sessionStorage.setItem('sessionId', sessionId); // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ sessionId Ğ² SessionStorage
    sessionInfoEl.textContent = `Session ID: ${sessionId}`;  // ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ sessionId Ğ¿Ğ¾Ğ´ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Start
    sessionIdEl.textContent = `Session ID: ${sessionId}`;  // ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ sessionId Ğ² Ğ»Ğ¾Ğ³Ğµ
    log("ğŸ“© Ğ¡ĞµÑÑĞ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°: " + sessionId);
  }

  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ğ² ÑĞµÑÑĞ¸Ñ
  function addAudioChunk(chunk) {
    const session = JSON.parse(sessionStorage.getItem(sessionId));
    if (session) {
      session.audioChunks.push(chunk);
      sessionStorage.setItem(sessionId, JSON.stringify(session));  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞµÑÑĞ¸Ñ
    }
  }

  // Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸
  function finalizeSession() {
    sessionStorage.removeItem('sessionId');  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ sessionId Ğ¸Ğ· SessionStorage Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğ¸
    sessionInfoEl.textContent = "";  // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ sessionId Ğ¿Ğ¾Ğ´ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Start
    sessionIdEl.textContent = "";  // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ sessionId Ğ² Ğ»Ğ¾Ğ³Ğµ
    log(`Ğ¡ĞµÑÑĞ¸Ñ ${sessionId} Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°`);
  }

  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞµÑÑĞ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
  window.onload = checkSession;

  // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
  window.onbeforeunload = () => {
    finalizeSession();  // Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ ÑĞµÑÑĞ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸
  };

  btnStart.onclick = async () => {
    try {
      const voice = voiceSel.value;
      const langPair = langSel.value;

      ws = new WebSocket(WS_URL);
      ws.binaryType = "arraybuffer";

      ws.onmessage = (e) => {
        const msg = String(e.data);
        if (msg.startsWith("SESSION:")) {
          sessionId = msg.split(":")[1];
          log("ğŸ“© " + msg);
        } else {
          log(msg);
        }
      };

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: "register", voice, langPair }));
        ws.send("ping-init");
        log("âœ… Connected to WebSocket");
      };

      ws.onclose = () => log("âŒ Disconnected");

      audioCtx = new AudioContext();
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const source = audioCtx.createMediaStreamSource(stream);
      const worklet = new AudioWorkletNode(audioCtx, "recorder-processor");

      source.connect(worklet);
      worklet.port.onmessage = (e) => {
        const chunk = e.data;
        if (ws.readyState === WebSocket.OPEN) {
          addAudioChunk(chunk);  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‡Ğ°Ğ½Ğº Ğ² ÑĞµÑÑĞ¸Ñ
          ws.send(chunk.buffer);
        }
      };

      btnStart.disabled = true;
      btnStop.disabled = false;
      log("ğŸ™ï¸ Recording started");
    } catch (e) {
      log("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: " + e.message);
    }
  };

  btnStop.onclick = async () => {
    try {
      if (audioCtx) audioCtx.close();
      if (ws && ws.readyState === WebSocket.OPEN) ws.close();
      log("â¹ï¸ Recording stopped");
      btnStart.disabled = false;
      btnStop.disabled = true;

      if (sessionId) {
        log(`ğŸ§ Finished session: ${sessionId}`);
        await processSession();
        finalizeSession();  // Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ ÑĞµÑÑĞ¸Ñ
      }
    } catch (e) {
      log("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: " + e.message);
    }
  };

  async function processSession() {
    try {
      const voice = voiceSel.value;
      const langPair = langSel.value;

      log("ğŸ§© ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ñ‡Ğ°Ğ½ĞºĞ¸...");
      await fetch(`/translator/merge?session=${sessionId}`);
      log("ğŸ’¾ merged");

      log("ğŸ§  Whisper...");
      const w = await fetch(`/translator/whisper?session=${sessionId}&langPair=${encodeURIComponent(langPair)}`);
      const data = await w.json();
      const text = data.text || "";
      const detectedLang = data.detectedLang || null;
      log("ğŸ§  â†’ " + text);
      log("ğŸŒ Detected language: " + (detectedLang || "none"));

      let finalText = text;
      log("ğŸ¤– GPT...");
      const body = { text, mode: "translate", langPair, detectedLang };
      const g = await fetch("/translator/gpt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const gData = await g.json();
      finalText = gData.text;
      log("ğŸ¤– â†’ " + finalText);

      if (finalText) {
        log("ğŸ”Š TTS...");
        const t = await fetch(`/translator/tts?session=${sessionId}&voice=${voice}&text=${encodeURIComponent(finalText)}`);
        const tData = await t.json();
        log(`ğŸ”Š ${tData.url}`);
        const audio = new Audio(tData.url);
        audio.play();
      }
    } catch (e) {
      log("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: " + e.message);
    }
  }
}
