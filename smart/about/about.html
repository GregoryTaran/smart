<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<base href="../" />
<title>–û –ø—Ä–æ–µ–∫—Ç–µ</title>

<link rel="icon" href="assets/logo400.jpg" />
<link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="css/main.css" />
<link rel="stylesheet" href="about/about.css" />

<!-- üß† –ì–ª–æ–±–∞–ª—å–Ω—ã–π bootstrap –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
<script>
  (function () {
    const AUTH_CACHE_KEY = 'sv.auth.cache.v1';

    window.SV_AUTH = {
      isAuthenticated: false,
      userId: null,
      level: 1,
      levelCode: 'guest',
      email: null,
      displayName: null,
      loaded: false
    };

    function norm(data) {
      data = data || {};
      const isAuth = !!data.is_authenticated;
      let level    = Number(data.level);
      if (!Number.isFinite(level) || level <= 0) level = isAuth ? 2 : 1;
      return {
        isAuthenticated: isAuth,
        userId: data.user_id ?? null,
        level,
        levelCode: data.level_code || (level === 1 ? 'guest' : 'user'),
        email: data.email ?? null,
        displayName: data.display_name ?? null,
        loaded: true
      };
    }

    function dispatch() {
      document.dispatchEvent(new CustomEvent('sv:auth-ready', { detail: window.SV_AUTH }));
    }

    function read() {
      try {
        const raw = localStorage.getItem(AUTH_CACHE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function write(x) {
      try { localStorage.setItem(AUTH_CACHE_KEY, JSON.stringify(x)); } catch {}
    }

    // 1) –∏–∑ –∫—ç—à–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
    (function () {
      const c = read();
      if (!c) return;
      window.SV_AUTH = Object.assign({}, c, { loaded: true });
      dispatch();
    })();

    // 2) –≤ —Ñ–æ–Ω–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
    fetch('/api/auth/session', { credentials: 'include' })
      .then(r => r.json())
      .then(d => {
        const s = norm(d);
        window.SV_AUTH = s;
        write(s);
        dispatch();
      })
      .catch(() => dispatch());
  })();
</script>

<!-- topbar/menu -->
<script type="module">
  import { initPage } from './js/topbar.module.js';
  initPage({
    fragments: [['menu.html', '#sidebar']],
    cacheBust: false,
    topbar: { state: { logoHref: 'index.html', logoSrc: 'assets/logo400.jpg' } }
  });
</script>


<!-- –†–∞–∑—Ä–µ—à–µ–Ω–∏—è -->
<script defer src="js/zaprosrazreshenijbrauzera.js"></script>

<!-- –ì–µ–æ-–≤–∏–¥–∂–µ—Ç -->
<script defer src="js/footer.geo.bundle.js"></script>

<script type="module" src="js/super-informer.js"></script>

</head>

<body>
<div id="page">
  <aside id="sidebar"></aside>

  <div id="app">
    <header id="topbar"></header>

    <main id="main">

      <!-- –ö–ê–†–¢–û–ß–ö–ê 0: –û –ü–†–û–ï–ö–¢–ï -->
      <section class="card about-card">
        <h1>–û –ø—Ä–æ–µ–∫—Ç–µ</h1>
        <p>–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞.</p>
      </section>


      <!-- –ö–ê–†–¢–û–ß–ö–ê 1: –†–ê–ó–†–ï–®–ï–ù–ò–Ø -->
      <section class="card">
        <h2>–†–∞–∑—Ä–µ—à–µ–Ω–∏—è</h2>

        <div class="stack-16">
          <button class="btn-purple" id="btnMic">–†–∞–∑—Ä–µ—à–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
          <button class="btn-purple" id="btnCam">–†–∞–∑—Ä–µ—à–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
          <button class="btn-purple" id="btnNoti">–†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
          <button class="btn-purple" id="btnGeo">–†–∞–∑—Ä–µ—à–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é</button>
        </div>

        <p id="permStatus">status: idle</p>
      </section>


      <!-- –ö–ê–†–¢–û–ß–ö–ê 2: –ì–ï–û–õ–û–ö–ê–¶–ò–Ø -->
      <section class="card">
        <h2>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</h2>

        <div id="geo-card"></div>

        <script>
          document.addEventListener("DOMContentLoaded", () => {
            try { SVFooter.mount("geo-card"); } catch(e) { console.warn(e); }
          });
        </script>
      </section>


      <!-- –ö–ê–†–¢–û–ß–ö–ê 3: –ë–û–õ–¨–®–û–ô –ò–ù–§–û–†–ú–ï–† -->
      <section class="card">
            <h2>–ë–æ–ª—å—à–æ–π –∏–Ω—Ñ–æ—Ä–º–µ—Ä</h2>

            <div id="about-informer" class="big-informer">
              –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É–ø–µ—Ä-–∏–Ω—Ñ–æ—Ä–º–µ—Ä–∞...
            </div>

            <script type="module">
              import { collectSuperInfo } from "./js/super-informer.js";

              async function renderSuper() {
                const info = await collectSuperInfo();

                document.querySelector("#about-informer").innerHTML = `
                  <div class="inf-group">
                    <h3>SV_AUTH</h3>
                    <pre>${JSON.stringify(info.svAuth, null, 2)}</pre>
                  </div>

                  <div class="inf-group">
                    <h3>Public IP</h3>
                    <pre>${JSON.stringify(info.publicIP, null, 2)}</pre>
                  </div>

                  <div class="inf-group">
                    <h3>Permissions</h3>
                    <pre>${JSON.stringify(info.permissions, null, 2)}</pre>
                  </div>

                  <div class="inf-group">
                    <h3>Battery</h3>
                    <pre>${JSON.stringify(info.battery, null, 2)}</pre>
                  </div>

                  <div class="inf-group">
                    <h3>Device</h3>
                    <pre>${JSON.stringify(info.device, null, 2)}</pre>
                  </div>

                  <div class="inf-group">
                    <h3>Screen</h3>
                    <pre>${JSON.stringify(info.screen, null, 2)}</pre>
                  </div>

                  <div class="inf-group">
                    <h3>Network</h3>
                    <pre>${JSON.stringify(info.network, null, 2)}</pre>
                  </div>

                  <div class="inf-group">
                    <h3>Storage</h3>
                    <pre>${JSON.stringify(info.storage, null, 2)}</pre>
                  </div>

                  <div class="inf-group">
                    <h3>WebGL (GPU)</h3>
                    <pre>${JSON.stringify(info.webgl, null, 2)}</pre>
                  </div>

                  <div class="inf-group">
                    <h3>Timestamp</h3>
                    <pre>${JSON.stringify(info.timestamp, null, 2)}</pre>
                  </div>
                `;
              }

              document.addEventListener("sv:auth-ready", renderSuper);
            </script>
          </section>


    </main>
  </div>
</div>

<div id="overlay" hidden></div>

</body>
</html>
