SMART VISION — Монтаж фронта (CWD-based)

Этот документ описывает, как backend (FastAPI/uvicorn) раздаёт фронтенд-статику из папки smart/ с привязкой к текущей рабочей директории (CWD), и как правильно настроить <base> на страницах.

TL;DR (наша рабочая связка)

Где монтируем фронт: в корень сайта / (по умолчанию).

Как открываем:

Главная: https://<домен>/ или …/index.html

About: https://<домен>/about/about.html

Базы в HTML:

index.html → <base href="./" />

about/about.html → <base href="../" />

Эта пара работает и локально, и на сервере при корневом монтаже.

1) Как это работает

В main.py включён блок:

# --- ФРОНТЕНД СТАТИКА (CWD-based) ---
# SMART_FRONT_ROOT=/abs/path/to/smart  (опционально)
# SMART_MOUNT_PATH=/smart              (по умолчанию "/" если не задано)

SMART_FRONT_ROOT = os.environ.get("SMART_FRONT_ROOT", "").strip()
MOUNT_PATH       = os.environ.get("SMART_MOUNT_PATH", "/").strip() or "/"

cwd_root   = Path(os.getcwd()).resolve() / "smart"      # CWD/smart
fallback1  = Path(__file__).resolve().parents[1] / "smart"
fallback2  = Path(__file__).resolve().parents[1] / "Smart"  # на случай регистра

candidates = [Path(SMART_FRONT_ROOT) if SMART_FRONT_ROOT else None, cwd_root, fallback1, fallback2]
STATIC_ROOT = next((p.resolve() for p in candidates if p and p.exists()), None)

if STATIC_ROOT and STATIC_ROOT.exists():
    app.mount(MOUNT_PATH, StaticFiles(directory=str(STATIC_ROOT), html=True), name="frontend")


CWD-based: если запускать uvicorn из корня репозитория, где server/ и smart/ лежат рядом, сервер возьмёт фронт из CWD/smart.

На случай другого запуска есть фолбэки ../smart и ../Smart.

html=True означает, что при заходе на папку (например, / или /about/) по умолчанию вернётся index.html внутри этой папки (если он там есть).

2) Переменные окружения

SMART_FRONT_ROOT — абсолютный путь к фронту (переопределяет поиск CWD/smart).
Пример:
SMART_FRONT_ROOT=/var/www/smart

SMART_MOUNT_PATH — публичный префикс, под которым раздаётся фронт.

По умолчанию: "/" (корень сайта).

Можно выставить "/smart", тогда фронт будет жить по https://<домен>/smart/.

Для нашей текущей схемы ничего не задаём — оставляем корень (/).

3) Базы (<base>) и примеры
Если фронт смонтирован в КОРЕНЬ (SMART_MOUNT_PATH="/") — наш текущий режим

Главная страница находится в корне / → удобно использовать относительную базу ./:

<!-- index.html -->
<base href="./" />


Это делает все пути (например, assets/..., js/..., css/...) относительными к текущему документу — в корне они резолвятся как /assets/..., /js/... и т.д.

Страницы в подпапках (например, /about/about.html) должны «выходить» на уровень выше — к корню:

<!-- about/about.html -->
<base href="../" />


Тогда href="assets/logo400.jpg" станет /assets/logo400.jpg, src="js/app.js" → /js/app.js, и т.д.

Такой дуэт ./ и ../ консистентно работает и локально, и на сервере, если фронт раздаётся из корня домена.

Если когда-нибудь решишь монтировать под префикс (SMART_MOUNT_PATH="/smart")

Тогда на всех страницах ставь абсолют:

<base href="/smart/" />


И открывай страницы как https://<домен>/smart/…

4) Проверка работоспособности

Запусти локально из корня проекта:

uvicorn server.main:app --host 0.0.0.0 --port 8000


Открой:

http://localhost:8000/.static-check (или /smart/.static-check — если менял префикс)

http://localhost:8000/ и http://localhost:8000/about/about.html

На проде:

https://<домен>/.static-check

https://<домен>/ и https://<домен>/about/about.html

.static-check вернёт JSON с:

static_root — фактический путь к папке фронта,

base_path — куда смонтировано (/ или /smart),

cwd — текущая рабочая директория процесса.

5) Частые проблемы и решения

404 у index.html:

Проверь, что STATIC_ROOT указывает на папку, где реально лежит index.html.

Убедись, что сервер запущен из корня репозитория (чтобы CWD/smart был корректен), либо задай SMART_FRONT_ROOT.

Текст страницы отдаётся, а скрипты/стили — нет:

Почти всегда это неправильный <base>.
При корневом монтаже:

в index.html должно быть <base href="./" />

в about/about.html — <base href="../" />

Проверь в DevTools → Network, какие именно URL у ресурсов:

Должны быть /js/..., /assets/..., /css/..., /svid/... и т.д.

Разные регистры папок на сервере (Linux чувствителен к регистру):

Smart/ и smart/ — разные папки. Следим, чтобы деплой создавал ровно smart/.

Конфликт с API:

Убедись, что app.mount(...) со статикой объявлен после всех include_router(...) для /api/*, /data/*, WS и т.п., чтобы статика не перехватывала эти маршруты.

Меняешь префикс (SMART_MOUNT_PATH=/smart) — всё сломалось:

Значит, страницы остались со старыми <base>. При префиксе /smart нужен абсолют:

<base href="/smart/" />


И открывать нужно https://<домен>/smart/...

6) Рекомендации по структуре

Рядом в репозитории:

/server
/smart


Внутри smart/ (примерно):

smart/
  index.html          # <base href="./" />
  about/
    about.html        # <base href="../" />
  login/
    login.html        # <base href="../" />
  js/
  css/
  assets/
  svid/
  manifest.json
  favicon.ico

7) Быстрый чек-лист перед деплоем

 Запуск из корня репозитория (где лежат server/ и smart/).

 SMART_MOUNT_PATH не задан (или равен /) — значит раздаём из корня.

 index.html → <base href="./" />.

 about/about.html, login/login.html → <base href="../" />.

 Открывается / и все ресурсы грузятся (200 в Network).

 .static-check показывает корректный static_root и base_path.

Если когда-нибудь решим переехать на префикс (/smart) — просто выставим SMART_MOUNT_PATH=/smart и заменим <base> на всех страницах на <base href="/smart/">. Но текущая связка (корневой монтаж + ./ / ../) уже стабильна и одинаково работает на ПК и на сервере.