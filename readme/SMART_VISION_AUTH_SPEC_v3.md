# SMART VISION ‚Äî AUTH SPEC v3 (Full System Reference)

## 0. Overview

–ü–æ–ª–Ω–∞—è, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è, ¬´–≤—Å—ë –≤ –æ–¥–Ω–æ–º¬ª —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ SMART VISION.  
–í–µ—Ä—Å–∏—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É, –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ –±—É–¥—É—â–µ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ.

–í–∫–ª—é—á–∞–µ—Ç:

- Backend (FastAPI + Supabase)
- –¢–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–¥–µ–ª—å —Å–µ—Å—Å–∏–π
- Client bootstrap —Å –∫—ç—à–µ–º
- –õ–æ–≥–∏–∫—É topbar / –º–µ–Ω—é / —Ñ—É—Ç–µ—Ä–∞
- –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü
- –†–æ–ª–∏, —É—Ä–æ–≤–Ω–∏, –∫–æ–¥—ã —É—Ä–æ–≤–Ω–µ–π
- –ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

---

# 1. Backend Architecture

Backend = **–∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã**.  
Frontend = –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–æ, —á—Ç–æ —Å–∫–∞–∑–∞–ª backend.

–ó–∞–ø—Ä–æ—Å—ã –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ **–ù–ï** –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.  
–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ:

1. `sv_session` ‚Äî HttpOnly cookie
2. `auth_sessions` ‚Äî –∑–∞–ø–∏—Å—å –≤ –ë–î
3. `users` ‚Äî –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

# 2. Database Schema

## 2.1. –¢–∞–±–ª–∏—Ü–∞ `users`

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Supabase (Postgres).

```
public.users (
  user_id        UUID PRIMARY KEY,
  email          TEXT UNIQUE,
  password       TEXT,          -- plain text (–≤—Ä–µ–º–µ–Ω–Ω–æ)
  password_hash  TEXT,          -- –¥–ª—è –±—É–¥—É—â–µ–≥–æ bcrypt
  display_name   TEXT,
  level          SMALLINT,      -- –¥–æ—Å—Ç—É–ø: 1=guest, 2=user, 3=paid, 4=super
  created_at     TIMESTAMPTZ
)
```

### –ß—Ç–æ –≤–∞–∂–Ω–æ:

- Email —É–Ω–∏–∫–∞–ª–µ–Ω.
- –ü–æ–∫–∞ –ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –≤–∏–¥–µ plain text ‚Üí —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å—Ç–∞–¥–∏—è –ø—Ä–æ–µ–∫—Ç–∞.
- `level` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø –≤ –º–µ–Ω—é.
- `display_name` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ UI.

---

## 2.2. –¢–∞–±–ª–∏—Ü–∞ `auth_sessions`

–•—Ä–∞–Ω–∏—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏.

```
public.auth_sessions (
  session_id   UUID PRIMARY KEY,
  user_id      UUID REFERENCES users(user_id) ON DELETE CASCADE,
  created_at   TIMESTAMPTZ,
  last_seen_at TIMESTAMPTZ,
  expires_at   TIMESTAMPTZ,
  ip_address   INET,
  user_agent   TEXT,
  is_active    BOOLEAN DEFAULT TRUE,
  session_data JSONB
)
```

### –ß—Ç–æ –≤–∞–∂–Ω–æ:

- –í –æ–¥–Ω–æ–π —É—á—ë—Ç–∫–µ –º–æ–∂–µ—Ç –±—ã—Ç—å **–º–Ω–æ–≥–æ —Å–µ—Å—Å–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ** (–º—É–ª—å—Ç–∏-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞).
- Backend –æ–±–Ω–æ–≤–ª—è–µ—Ç `last_seen_at` –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.
- –°–µ—Å—Å–∏—è –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å:
  - –ø—Ä–∏ logout  
  - –µ—Å–ª–∏ expires_at < now  
  - –µ—Å–ª–∏ is_active = false  
  - –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (CASCADE)

---

# 3. Level System

–£—Ä–æ–≤–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

| Level | Code  | –ó–Ω–∞—á–µ–Ω–∏–µ |
|-------|--------|----------|
| 1     | guest | –ì–æ—Å—Ç—å (–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω) |
| 2     | user  | –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å |
| 3     | paid  | –ü–ª–∞—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç |
| 4     | super | –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ / –∞–¥–º–∏–Ω |

–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ:

```
level_to_code(level)
```

---

# 4. Backend Endpoints

## 4.1. `POST /api/auth/register`

–°–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—Ä–æ–≤–Ω–µ–º 2.

```
{
  "ok": true,
  "user_id": "uuid"
}
```

## 4.2. `POST /api/auth/login`

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç email + password
- –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ `auth_sessions`
- –í—ã–¥–∞—ë—Ç cookie:

```
sv_session = session_id
HttpOnly, secure, samesite=lax
```

## 4.3. `POST /api/auth/logout`

- –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–µ—Å—Å–∏—é
- –£–¥–∞–ª—è–µ—Ç –∫—É–∫—É

## 4.4. `POST /api/auth/reset`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å, –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ users.password.

## 4.5. `GET /api/auth/session`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞:

```
{
  "is_authenticated": true/false,
  "user_id": "...",
  "level": 1..4,
  "level_code": "...",
  "email": "...",
  "display_name": "..."
}
```

---

# 5. Frontend Bootstrap (Head Script)

–°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫—ç—à**:

### –ê–ª–≥–æ—Ä–∏—Ç–º

1. –ß–∏—Ç–∞–µ–º –∏–∑ `localStorage.sv.auth.cache.v1`.
2. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ–º `window.SV_AUTH`.
3. –ö–∏–¥–∞–µ–º `sv:auth-ready` ‚Üí UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ä–∞–∑—É.
4. –í —Ñ–æ–Ω–µ ‚Üí –≤—ã–∑—ã–≤–∞–µ–º `/api/auth/session`.
5. –û–±–Ω–æ–≤–ª—è–µ–º SV_AUTH, –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à, —Å–Ω–æ–≤–∞ –∫–∏–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- –í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è **–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ**.
- –£–±–∏—Ä–∞–µ—Ç—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞ 2‚Äì3 —Å–µ–∫.
- –†–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –¥–æ–≥–æ–Ω—è–µ—Ç –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞.

---

# 6. window.SV_AUTH Format

```
{
  isAuthenticated: Boolean,
  userId: String|null,
  level: Number,
  levelCode: "guest"|"user"|"paid"|"super",
  email: String|null,
  displayName: String|null,
  loaded: Boolean
}
```

---

# 7. Events

### –°–æ–±—ã—Ç–∏—è, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ —Å–∏—Å—Ç–µ–º–æ–π

| Event | –ö—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç | –ö–æ–≥–¥–∞ |
|--------|----------------|--------|
| `sv:auth-ready` | bootstrap | –£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ SV_AUTH |
| `sv:logout` | topbar | –ü–æ—Å–ª–µ logout |
| `pageshow` | –±—Ä–∞—É–∑–µ—Ä | –í–æ–∑–≤—Ä–∞—Ç –∏–∑ bfcache |
| `storage` | –±—Ä–∞—É–∑–µ—Ä | –î—Ä—É–≥–∞—è –≤–∫–ª–∞–¥–∫–∞ –æ—á–∏—Å—Ç–∏–ª–∞ –∫—ç—à |

---

# 8. Topbar Logic

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç topbar:

1. –†–µ–Ω–¥–µ—Ä–∏—Ç –ª–æ–≥–æ—Ç–∏–ø.
2. –†–µ–Ω–¥–µ—Ä–∏—Ç –∫–Ω–æ–ø–∫—É –ª–æ–≥–∏–Ω–∞/–ª–æ–≥–∞—É—Ç–∞.
3. –û–±–Ω–æ–≤–ª—è–µ—Ç UI –ø—Ä–∏ `sv:auth-ready`.
4. –ü—Ä–∏ logout:
   - –≤—ã–∑—ã–≤–∞–µ—Ç `/api/auth/logout`
   - —á–∏—Å—Ç–∏—Ç –∫—ç—à
   - –∫–∏–¥–∞–µ—Ç `sv:logout`
   - –¥–µ–ª–∞–µ—Ç redirect

Topbar —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω:

- –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã  
- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ JS ‚Üí instant

---

# 9. Footer Logic

–§—É—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ:

- —Å–ª—É—à–∞–µ—Ç `sv:auth-ready`
- —á–∏—Ç–∞–µ—Ç `SV_AUTH`
- —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∫–∞—Ä—Ç–æ—á–∫—É —Å:
  - —É—Ä–æ–≤–Ω–µ–º
  - email
  - userId
  - levelCode

–§—É—Ç–µ—Ä –ù–ï –≥—Ä—É–∑–∏—Ç –≤–Ω–µ—à–Ω–∏—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ ‚Üí instant.

---

# 10. Left Menu Logic (–ü–æ—á–µ–º—É –≥—Ä—É–∑–∏—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–µ–µ)

–õ–µ–≤–æ–µ –º–µ–Ω—é ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π:

### 1) –°–Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–Ω–µ—à–Ω—é—é —Ä–∞–∑–º–µ—Ç–∫—É:

```
menu.html
```

–≠—Ç–æ fetch-–∑–∞–ø—Ä–æ—Å.

### 2) –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è menu.html

–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:

```
renderMenu(level)
```

–∫–æ—Ç–æ—Ä—ã–π –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é –≤ `[data-svid-menu]`.

üìå –û—Ç—Å—é–¥–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ 1‚Äì2 —Å–µ–∫—É–Ω–¥—ã  
(—É —Ç–µ–±—è —Ç–∞–∫ –∏ –±—ã–ª–æ ‚Äî –∏–º–µ–Ω–Ω–æ –º–µ–Ω—é –ø—Ä–∏–µ–∑–∂–∞–µ—Ç –ø–æ–∑–∂–µ).

### –ß—Ç–æ –º–µ–Ω—é —É—á–∏—Ç—ã–≤–∞–µ—Ç:

- –¢–æ–ª—å–∫–æ `SV_AUTH.level`  
- –§–∏–ª—å—Ç—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ MENU –ø–æ `allow: [1/2/3/etc]`.

---

# 11. MENU Structure

–ú–µ–Ω—é –æ–ø–∏—Å–∞–Ω–æ –≤ `topbar.module.js`:

```
const MENU = [
  { id:'home',  title:'–ì–ª–∞–≤–Ω–∞—è', href:'index.html', allow:[1,2] },
  { id:'about', title:'–û –ø—Ä–æ–µ–∫—Ç–µ', href:'about/about.html', allow:[1,2] },
  { id:'ts',    title:'–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', href:'testserver/testserver.html', allow:[2] },
  { id:'rec',   title:'–î–∏–∫—Ç–æ—Ñ–æ–Ω', allow:[2] },
  { id:'vision',title:'–ü—É—Ç—å –ø–æ –≤–∏–∑–∏–∏', allow:[2] },
  ...
]
```

### –ü—Ä–∏–Ω—Ü–∏–ø:

- level 1 ‚Üí –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –º–µ–Ω—é
- level 2 ‚Üí –ø–æ—á—Ç–∏ –≤—Å—ë
- allow –º–∞—Å—Å–∏–≤ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

---

# 12. What Future Bro Needs to Know

–≠—Ç–∞ —Å–µ–∫—Ü–∏—è ‚Äî –¥–ª—è –º–µ–Ω—è (ChatGPT-–ë—Ä–æ) —á—Ç–æ–±—ã –ø–æ–º–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞–≤—Å–µ–≥–¥–∞.

### –í–∞–∂–Ω–æ:

- –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞.
- –í—Å–µ –º–æ–¥—É–ª–∏ —á–∏—Ç–∞—é—Ç **—Ç–æ–ª—å–∫–æ** `SV_AUTH`.
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –í–°–ï–ì–î–ê –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º.
- –ö—ç—à ‚Äì ŸÅŸÇÿ∑ —É—Å–∫–æ—Ä–µ–Ω–∏–µ, –Ω–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã.
- –ú–µ–Ω—é —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è *–ø–æ—Å–ª–µ* –∑–∞–≥—Ä—É–∑–∫–∏ `menu.html`.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:

```
smart/
  index.html        <-- bootstrap –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  menu.html         <-- —Ñ—Ä–∞–≥–º–µ–Ω—Ç –ª–µ–≤–æ–≥–æ –º–µ–Ω—é
  js/
    topbar.module.js
    footer.js
  login/
    login.html
  vision/
    vision.html
server/
  svid/svid.py      <-- –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  main.py
supabase/
  public.users
  public.auth_sessions
```

---

# 13. Summary

AUTH SPEC v3 = –µ–¥–∏–Ω–∞—è, –ø–æ–ª–Ω–∞—è –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è SMART VISION:

- –¢–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ
- –ú–æ–¥–µ–ª—å —Å–µ—Å—Å–∏–π
- –õ–æ–≥–∏–≥–∞ backend
- Bootstrap —Å –∫—ç—à–µ–º
- Topbar / Menu / Footer
- –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –í–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è

---

SMART VISION ‚Äî –º–æ—â–Ω–∞—è, –±—ã—Å—Ç—Ä–∞—è –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞.  
–ë—Ä–æ –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º üß†üî•
