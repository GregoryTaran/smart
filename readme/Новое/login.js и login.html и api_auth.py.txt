===============================
SMART VISION — АУТЕНТИФИКАЦИЯ
===============================

В ПРОЦЕССЕ УЧАСТВУЮТ ТРИ ФАЙЛА:
1) login.html — визуальная страница
2) login.js   — логика клиента (браузер)
3) api_auth.py — серверная аутентификация (FastAPI + Supabase)

Они образуют полный цикл: ВХОД → ВЫДАЧА КУКИ → ПРОВЕРКА → ИДЕНТИФИКАЦИЯ


==============================================================
1) ФАЙЛ login.html — СТРАНИЦА / ФОРМА ВХОДА
==============================================================

ФАЙЛ ЗАНИМАЕТСЯ:
• Отрисовкой UI: формы входа, регистрации, сброса пароля  
• Выставляет три формы:
    – #form-register
    – #form-login
    – #form-reset
• На странице подключается:
    ✔ smartid.init.js — для topbar/footer  
    ✔ login.js — для обработки кнопок и отправки запросов

login.html НИЧЕГО НЕ ПИШЕТ НА СЕРВЕР  
login.html НИЧЕГО НЕ ИЗМЕНЯЕТ  
Он — просто оболочка для форм.


==============================================================
2) ФАЙЛ login.js — КЛИЕНТСКАЯ АУТЕНТИФИКАЦИЯ
==============================================================

ФАЙЛ ДЕЛАЕТ:
• принимает ввод email/пароль
• отправляет запросы на сервер:
      POST /api/auth/register
      POST /api/auth/login
      POST /api/auth/logout
      POST /api/auth/reset-dev
• ПОСЛЕ успешного логина делает:
      GET /api/auth/me
  чтобы убедиться, что куки выданы и сессия создана

login.js УМЕЕТ ПИСАТЬ НА СЕРВЕР:
--------------------------------
Да:
    POST /api/auth/login     → создаёт новую сессию (сервер выдаёт куки)
    POST /api/auth/register  → создаёт пользователя в Supabase
    POST /api/auth/logout    → удаляет куки на сервере
    POST /api/auth/reset-dev → меняет пароль (только dev)

login.js НЕ УМЕЕТ ИЗМЕНЯТЬ СЕССИИ НАПРЯМУЮ  
login.js просто шлёт запросы, а сервер занимается сессией и куками.

ПОСЛЕ УСПЕШНОГО ЛОГИНА:
--------------------------------
login.js делает:
    location.replace('/index.html')
→ то есть он делает редирект на главную страницу.


==============================================================
3) ФАЙЛ api_auth.py — СЕРВЕР АУТЕНТИФИКАЦИИ
==============================================================

ЭТО ГЛАВНЫЙ ЦЕНТР АВТОРИЗАЦИИ.

Этот файл:
--------------------------------
✔ общается с Supabase (API аутентификации)  
✔ создаёт пользователей  
✔ логинит пользователей  
✔ выдаёт access_token + refresh_token  
✔ пишет эти токены в куки  
✔ удаляет куки при logout  
✔ проверяет токен при вызове /me  
✔ возвращает уровень доступа (guest / user / admin)  
✔ возвращает объединённый профиль пользователя  
✔ умеет менять пароль  
✔ умеет делать reset-password

api_auth.py ПИШЕТ:
--------------------------------
• Устанавливает куки через `_set_auth_cookies`  
• Удаляет куки через `_clear_auth_cookies`  
• Пишет в Supabase (регистрация, смена пароля)  
• Обновляет пользователя в Supabase Admin API  
• Возвращает JSON ответы клиенту

Это единственный компонент системы, который:
    - ставит куки
    - читает куки
    - проверяет токены
    - решает, кто этот пользователь
    - присваивает уровни доступа

==============================================================
4) КАК ОНИ ВЗАИМОДЕЙСТВУЮТ
==============================================================

1) Пользователь открывает login.html  
2) Вводит email + пароль  
3) login.js делает **POST /api/auth/login → api_auth.py**  
4) api_auth.py:
       • отправляет запрос в Supabase
       • проверяет данные
       • получает токены
       • СТАВИТ КУКИ В ОТВЕТ (httponly cookies!)
5) login.js получает ответ и делает GET /api/auth/me  
6) api_auth.py подтверждает:
       loggedIn: true
       user_merged: {...}
       level: ...
7) login.js делает redirect('/index.html')  
8) На index.html запускается smartid.init.js  
9) smartid.init.js делает GET /api/auth/me и показывает интерфейс авторизованного пользователя.


==============================================================
5) ИТОГОВЫЙ ЦИКЛ АВТОРИЗАЦИИ
==============================================================

[login.html] — UI  
   ↳ вызывает  
[login.js] — запросы  
   ↳ вызывает  
[api_auth.py] — выдаёт куки + проверяет токены  
   ↳ а затем  
[smartid.init.js] — на любой странице читает /me и определяет пользователя

Таким образом:
• api_auth.py — мозг  
• login.js — руки  
• login.html — лицо  
• smartid.init.js — глаза системы на каждой странице


==========================================================
1) ТАБЛИЦА №1 — auth.users  (встроенная)
==========================================================

КТО ПИШЕТ:  
  • Supabase Auth (автоматически)  
  • api_auth.py (через эндпоинты /signup и /token)

КОГДА ПИШЕТСЯ:
  ✓ Регистрация (POST /api/auth/register)  
  ✓ Вход (подтверждение логина)  
  ✓ Получение профиля (/auth/v1/user)

ЧТО ХРАНИТ:
  • id (UUID) — уникальный идентификатор пользователя  
  • email  
  • hashed password  
  • user_metadata (объект):
        - name (мы туда пишем)
        - avatar (если будет)
        - role (если добавим)
  • created_at  
  • updated_at  
  • last_sign_in_at

ЭТО ОСНОВНАЯ СИСТЕМНАЯ ТАБЛИЦА USER AUTHENTICATION.


==========================================================
2) ТАБЛИЦА №2 — profiles  (ваша кастомная таблица)
==========================================================

КТО ПИШЕТ:
  • api_auth.py → функция _fetch_profile() читает  
  • Создаётся вручную в Supabase (или миграцией)

КОГДА ПИШЕТСЯ:
  ✓ После регистрации (обычно создаётся пустая запись)  
  ✓ Когда нужно хранить:
        - role  
        - name  
        - avatar  
        - is_guest  
        - любые кастомные поля проекта

ЧТО ХРАНИТ:
  • id (совпадает с auth.users.id)  
  • role (guest/user/admin)  
  • name  
  • avatar  
  • is_guest  
  • created_at  
  • любые кастомные данные

ЭТО ПОЛЬЗОВАТЕЛЬСКИЙ ПРОФИЛЬ (расширение auth.users).


==========================================================
3) ТАБЛИЦА №3 — auth.sessions  (встроенная в Supabase)
==========================================================

КТО ПИШЕТ:
  • сама Supabase Auth (автоматически)

КОГДА ПИШЕТ:
  ✓ При логине  
  ✓ При обновлении токена  
  ✓ При logout (косвенно)

ЧТО ХРАНИТ:
  • access_token  
  • refresh_token  
  • expiry  
  • user_id  
  • device info  
  • IP/agent

ЭТА ТАБЛИЦА НЕ УПРАВЛЯЕТСЯ РАВНО С НАШЕЙ СИСТЕМОЙ — ЭТО НЕ ТВОЙ КОД.


==========================================================
4) ТАБЛИЦА №4 — auth.refresh_tokens  (встроенная)
==========================================================

КОГДА ПИШЕТСЯ:
  ✓ при каждом логине  
  ✓ при каждом обновлении сессии

ЭТА ТАБЛИЦА ТЕБЕ НУЖНА ТОЛЬКО ДЛЯ ОТЛАДКИ.


==========================================================
5) ТАБЛИЦА №5 — auth.mfa_* (mfa_factors, mfa_challenges)
==========================================================

Пишутся Supabase-ом, если включена MFA.  
Сейчас у вас **не используется** (по коду — нет).


==========================================================
ИТОГОВОЕ СОСТОЯНИЕ:  
СЕЙЧАС SMART VISION ИСПОЛЬЗУЕТ ТОЛЬКО 2 ТАБЛИЦЫ ДЛЯ ПОЛЬЗОВАТЕЛЕЙ:
==========================================================

1) auth.users      ← создаёт Supabase Auth  
2) profiles        ← ваша кастомная таблица

Остальные таблицы Supabase Auth существуют, но вас не касаются напрямую.


==========================================================
КАК РАСПРЕДЕЛЯЮТСЯ ДАННЫЕ?
==========================================================

ПРИ РЕГИСТРАЦИИ:
  auth.users:
      - email
      - password (хэш)
      - metadata.name (из register form)
      - id (UUID)
  
  profiles:
      - id (тот же UUID)
      - role = "user"
      - name (если запишем)
      - avatar (в будущем)
      - is_guest = false

ПРИ ВХОДЕ:
  auth.users:
      - проверка email/pass
      - обновление last_sign_in_at
  
  sessions + refresh_tokens:
      - выдаются access + refresh токены

ПРИ ЧТЕНИИ /me:
  • auth.users читается через Bearer access_token  
  • profiles читается через PostgREST  


==========================================================
ЗАКЛЮЧЕНИЕ:
----------------------------------------------------------
Сейчас система полностью построена на:

★ auth.users — база для авторизации  
★ profiles — расширенный профиль пользователя  

Все остальные таблицы Supabase — это служебные внутренние таблицы.


