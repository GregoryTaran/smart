# EventCenter ‚Äî –û–ü–ò–°–ê–ù–ò–ï –ò –¢–ó

## 0. –û–ë–©–ê–Ø –ó–ê–î–ê–ß–ê

**–û–ë–©–ê–Ø –ó–ê–î–ê–ß–ê: –£–î–û–ë–ù–û –°–õ–ê–¢–¨ –°–û–û–ë–©–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ.**

–¶–µ–ª—å: —Å–¥–µ–ª–∞—Ç—å –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å EventCenter, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –ª—é–±—ã–µ —Å–µ—Ä–≤–∏—Å—ã Smart Vision –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á–µ–ª–æ–≤–µ–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —Ä–∞–∑–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º:

- –æ–Ω–ª–∞–π–Ω (WebSocket),  
- –æ—Ñ—Ñ–ª–∞–π–Ω (Push + Service Worker),  
- e-mail,  
- (–≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë –∫–∞–Ω–∞–ª—ã).

---

## 1. –í–≤–æ–¥–Ω—ã–µ

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**

- –°–µ—Ä–≤–µ—Ä: **Python + FastAPI**
- –ë—Ä–∞—É–∑–µ—Ä: **Chrome (Android / Windows)**

**–¶–µ–ª—å:**  
–∞–¥—Ä–µ—Å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

- –æ–Ω–ª–∞–π–Ω ‚Äî —á–µ—Ä–µ–∑ **WebSocket**,  
- –æ—Ñ—Ñ–ª–∞–π–Ω ‚Äî —á–µ—Ä–µ–∑ **Push + Service Worker**,  
- –ø–ª—é—Å **–º–µ–π–ª**,  
- –∏ –≤ –±—É–¥—É—â–µ–º –µ—â—ë —á—Ç–æ-—Ç–æ.

---

## 2. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ü–∞–ø–∫–∞ `server/`:

```text
server/
  auth/
  core/
  data/
  database/
  identity/
  svid/
  voicerecorder/
  eventcenter/       
    __init__.py
    models.py
    service.py
    websocket_dispatcher.py
    push_dispatcher.py
    email_dispatcher.py
  .env
  .env.example
  .python-version
  database_readme.md
  main.py
  requirements.txt
```

–ú–æ–¥—É–ª—å **EventCenter** –ª–µ–∂–∏—Ç –≤ `server/eventcenter/` –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.

---

## 3. –ë–ê–ó–û–í–ê–Ø –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê

### –ê. –ü–û–î–ù–Ø–¢–¨ –í–ï–ë–°–û–ö–ï–¢

**–ó–∞–¥–∞—á–∏:**

- –í FastAPI –ø–æ–¥–Ω—è—Ç—å **WebSocket-—ç–Ω–¥–ø–æ–∏–Ω—Ç**.  
- –ü–æ–¥–Ω–∏–º–∞–µ–º WebSocket-—ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–∞ FastAPI.  
- –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–Ω–∏–º–∞–µ–º `user_id` (–ø–æ —Ç–æ–∫–µ–Ω—É/–∫—É–∫–µ/–ø–∞—Ä–∞–º–µ—Ç—Ä—É).  
- –î–µ—Ä–∂–∏–º:

```text
user_id -> [—Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö WebSocket-—Å–µ—Å—Å–∏–π]
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–Ω–ª–∞–π–Ω-—Å–∏–≥–Ω–∞–ª—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

---

### –ë. –ü–û–î–ü–ò–°–ê–¢–¨ –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ù–ê PUSH

**–õ–æ–≥–∏–∫–∞:**

–ù–∞ —Ñ—Ä–æ–Ω—Ç–µ:

- —Ä–µ–≥–∞–µ–º `ServiceWorker`,  
- –ø—Ä–æ–≤–µ—Ä—è–µ–º / –ø—Ä–æ—Å–∏–º `Notification.permission`,  
- —á–µ—Ä–µ–∑ `registration.pushManager.subscribe(...)` –ø–æ–ª—É—á–∞–µ–º `pushSubscription`.  

–î–∞–ª—å—à–µ:

- —à–ª—ë–º —ç—Ç–æ –Ω–∞ `POST /api/push/subscribe`,  
- –≤ –±–∞–∑–µ —Ö—Ä–∞–Ω–∏–º `user_id ‚Üí —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫`  
  (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏: endpoint + –∫–ª—é—á–∏ + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞).

üëâ **–í–∞–∂–Ω–æ:** –ø–æ–¥–ø–∏—Å–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ (–Ω–æ—É—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –≤—Ç–æ—Ä–æ–π –±—Ä–∞—É–∑–µ—Ä) ‚Äî —ç—Ç–æ –Ω–æ—Ä–º.

---

### –í. NotificationDiagnostics (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è)

–û–¥–∏–Ω –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π:

- –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: `ServiceWorker`, `Push`, `WebSocket`, –∑–≤—É–∫, –∫–∞–º–µ—Ä–∞, –º–∏–∫—Ä–æ—Ñ–æ–Ω, –∏ —Ç.–¥.  
- –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ ‚Äî **–ø–æ–Ω—è—Ç–Ω–æ –æ–±—ä—è—Å–Ω—è–µ—Ç —á–µ–ª–æ–≤–µ–∫—É, —á—Ç–æ –≤–∫–ª—é—á–∏—Ç—å –∏ –≥–¥–µ**.

–≠—Ç–æ:

> ¬´–ï–¥–∏–Ω—ã–π —Ö–µ–ª–ø-—Ü–µ–Ω—Ç—Ä —Å—Ä–µ–¥—ã Smart Vision¬ª.

–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

- –ø–∞–Ω–µ–ª—å–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Ç–∏–ø–∞ ¬´–≤—Å—ë –∑–µ–ª—ë–Ω–æ–µ / —á—Ç–æ-—Ç–æ –∫—Ä–∞—Å–Ω–æ–µ¬ª),  
- –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥—ã¬ª.

---

### –ì. –°–î–ï–õ–ê–¢–¨ –ü–†–ê–í–ò–õ–¨–ù–´–ô SERVICE WORKER –î–õ–Ø –í–°–ï–ì–û –°–ê–ô–¢–ê

- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º `/sw.js` —Å –∫–æ—Ä–Ω—è ‚Üí `scope = –≤–µ—Å—å –¥–æ–º–µ–Ω`.  
- –í `sw.js`:
  - —Å–ª—É—à–∞–µ–º `push`,  
  - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (`showNotification`),  
  - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º `notificationclick` ‚Üí `clients.openWindow(url)`.

---

### –î. –°–¥–µ–ª–∞—Ç—å Web Push —á–µ—Ä–µ–∑ VAPID (pywebpush), –±–µ–∑ –ø—Ä—è–º–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Firebase

- –ì–µ–Ω–µ—Ä–∏–º **VAPID –∫–ª—é—á–∏** (public/private).  
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º `pywebpush` –Ω–∞ FastAPI.  
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—à–∏ –Ω–∞ endpoint, –∫–æ—Ç–æ—Ä—ã–π –¥–∞–ª –±—Ä–∞—É–∑–µ—Ä  
  (`https://fcm.googleapis.com/...`), –∫–∞–∫ –Ω–∞ –æ–±—ã—á–Ω—ã–π URL  
  ‚Üí –±–µ–∑ Firebase SDK, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ Google-–æ–±–≤–µ—Å–∞.

---

## 4. –ï. –¶–µ–Ω—Ç—Ä —Å–æ–±—ã—Ç–∏–π / —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Smart Vision (EventCenter)

### –ï.0. –ò–¥–µ—è

**–¶–µ–ª—å:**

—á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –º–æ–≥ —Å–∫–∞–∑–∞—Ç—å —á–µ–ª–æ–≤–µ–∫—É –Ω–µ —Ç–æ–ª—å–∫–æ:

- ¬´—è –≤—Å—ë —Å–¥–µ–ª–∞–ª¬ª,

–Ω–æ –∏:

- ¬´–º–Ω–µ –Ω—É–∂–Ω–æ —Ç–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ¬ª,  
- ¬´–ø–æ—Å–º–æ—Ç—Ä–∏ —Å—é–¥–∞¬ª,  
- ¬´—á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫¬ª,  
- ¬´—É —Ç–µ–±—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π¬ª,  
- ¬´–ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ –ø–æ –ø—É—Ç–∏¬ª,

–∏ –≤—Å—ë —ç—Ç–æ **–≤ –æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ**, –ø–æ WebSocket –∏ —á–µ—Ä–µ–∑ Push –∏ Email.

---

### –ï1. –û–±—â–∞—è –º–æ–¥–µ–ª—å —Å–æ–±—ã—Ç–∏—è (–æ–¥–Ω–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ ‚Äú–ø–∏—Å—å–º–æ‚Äù)

–£—Å–ª–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±—ã—Ç–∏—è:

```jsonc
{
  "id": "evt_123",          // ID —Å–æ–±—ã—Ç–∏—è
  "user_id": 42,            // –∫–æ–º—É
  "type": "job.done",       // —Ç–∏–ø (—Å–º. –Ω–∏–∂–µ)
  "title": "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≥–æ—Ç–æ–≤–∞",
  "body": "–Ø –æ–±—Ä–∞–±–æ—Ç–∞–ª —Å–Ω–∏–º–æ–∫, –∑–∞—Ö–æ–¥–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å.",
  "level": "info",          // info | warning | error | critical
  "channels": ["ws", "push"], // –∫–∞–Ω–∞–ª—ã –¥–æ—Å—Ç–∞–≤–∫–∏: ws | push | email (–ª—é–±–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è)
  "cta": {                  // call-to-action (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    "label": "–û—Ç–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
    "url": "https://smart-vision.app/app/job/abc123"
  },
  "data": {                 // —Ç–µ—Ö. –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞
    "job_id": "abc123",
    "service": "photo_pipeline"
  },
  "created_at": "2025-11-14T12:00:00Z"
}
```

–≠—Ç–æ **–æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç**, –∫–æ—Ç–æ—Ä—ã–π:

- —Å–µ—Ä–≤–µ—Ä –∫–ª–∞–¥—ë—Ç –≤ –ë–î,  
- –ø–æ –Ω–µ–º—É –∂–µ —à–ª—ë—Ç –ø–æ WebSocket,  
- –ø–æ –Ω–µ–º—É –∂–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è payload –¥–ª—è Push,  
- –ø–æ –Ω–µ–º—É –∂–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è Email (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ).

**–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –≤–∞–∂–Ω–æ:**

- `user_id`  
- `type`  
- `title`  
- `body`  

–û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ (`channels`, `cta`, `data`).

---

### –ï2. –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π (–Ω–∞—à ‚Äú—Å–ª–æ–≤–∞—Ä—å‚Äù)

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä, —á—Ç–æ–±—ã –ø–æ–∫—Ä—ã—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

#### 1. `job.done` ‚Äî —Ä–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

–¢–æ, —á—Ç–æ –º—ã —É–∂–µ –æ–±—Å—É–∂–¥–∞–ª–∏.

- `title`: ¬´–†–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞¬ª  
- `body`: ¬´–Ø –≤—Å—ë –æ–±—Ä–∞–±–æ—Ç–∞–ª, –∑–∞—Ö–æ–¥–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç¬ª  
- `data.job_id`  
- `cta.url` –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞  

#### 2. `job.progress` ‚Äî –∏–¥—ë—Ç –ø—Ä–æ—Ü–µ—Å—Å

–ú–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –¥–ª—è –∂–∏–≤–æ–≥–æ UI.

- –ø—Ä–æ—Ü–µ–Ω—Ç, —Å—Ç–∞—Ç—É—Å, —à–∞–≥, –∏ —Ç.–ø.  
- –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.  
- –≤ Push –æ–±—ã—á–Ω–æ **–Ω–µ —à–ª—ë–º**, —Ç–æ–ª—å–∫–æ WS (online).

#### 3. `action.required` ‚Äî –ù–£–ñ–ù–û –î–ï–ô–°–¢–í–ò–ï –ß–ï–õ–û–í–ï–ö–ê ‚úÖ

–ü—Ä–∏–º–µ—Ä—ã:

- ¬´–í—ã–±–µ—Ä–∏, –∫–∞–∫—É—é –≤–µ—Ä—Å–∏—é –æ—Å—Ç–∞–≤–∏—Ç—å¬ª  
- ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏, —á—Ç–æ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É¬ª  
- ¬´–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ / –ø—É—Ç—å / —Ä–µ–∂–∏–º¬ª

–°–æ–±—ã—Ç–∏–µ:

```jsonc
{
  "type": "action.required",
  "title": "–ù—É–∂–Ω–æ –≤–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ",
  "body": "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç, –∫–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É.",
  "data": {
    "action_id": "act_777",
    "service": "vision_planner",
    "options": ["A", "B", "C"]
  },
  "cta": {
    "label": "–û—Ç–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä",
    "url": "https://smart-vision.app/app/actions/act_777"
  }
}
```

#### 4. `message.new` ‚Äî –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ / –æ—Ç–≤–µ—Ç

–î–ª—è —á–∞—Ç–∞, –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–π –≤–∏–∑–∏–∏.

- `title`: ¬´–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Symbiotic Way¬ª / –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- `body`: –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–∞  
- `data.thread_id` / `conversation_id`  
- `cta.url` ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–ª–æ–≥–∞.

#### 5. `reminder.due` ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ –ø—É—Ç–∏ / –∑–¥–æ—Ä–æ–≤—å—é

–¢–∏–ø–∞:

- ¬´–ü–æ—Ä–∞ –∑–∞–ø–∏—Å–∞—Ç—å –∏—Ç–æ–≥–∏ –¥–Ω—è¬ª  
- ¬´–í—Ä–µ–º—è –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∞–∫—Ç–∏–∫–∏¬ª  
- ¬´–¢—ã —Ö–æ—Ç–µ–ª –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —ç—Ç–æ–π –º—ã—Å–ª–∏¬ª

#### 6. `system.alert` ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ç—É–∫–∏

–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞, –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

---

### –ï3. –ö–∞–∫ —Å–µ—Ä–≤–µ—Ä —Ä–µ—à–∞–µ—Ç: WebSocket, Push –∏–ª–∏ –æ–±–∞?

–ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ-–ø—Ä–æ—Å—Ç–æ–º—É:

1. –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞—ë—Ç —Å–æ–±—ã—Ç–∏–µ –∏ –ø–∏—à–µ—Ç –µ–≥–æ –≤ –ë–î.  
2. –°–º–æ—Ç—Ä–∏—Ç: –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ WebSocket-—Å–µ—Å—Å–∏–∏ —É `user_id`?

- **–ï—Å—Ç—å –æ–Ω–ª–∞–π–Ω-—Å–µ—Å—Å–∏–∏** ‚Üí  
  —à–ª—ë–º —Å–æ–±—ã—Ç–∏–µ –ø–æ WebSocket, —Ñ—Ä–æ–Ω—Ç —Å—Ä–∞–∑—É —Ä–µ–∞–≥–∏—Ä—É–µ—Ç (toast, –º–æ–¥–∞–ª–∫–∞ –∏ —Ç.–¥.).

3. –°–º–æ—Ç—Ä–∏–º, —Ö–æ—á–µ—Ç –ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ —É–π—Ç–∏ –≤ Push/Email –ø–æ –ø–æ–ª—é `channels`:

- `["ws"]` ‚Üí —Ç–æ–ª—å–∫–æ WebSocket  
- `["ws", "push"]` ‚Üí WebSocket + Push  
- `["ws", "push", "email"]` ‚Üí WebSocket + Push + Email  
- –∏ —Ç.–ø.

4. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ Push ‚Üí  
   –±–µ—Ä—ë–º –≤—Å–µ `pushSubscription` —é–∑–µ—Ä–∞ ‚Üí —à–ª—ë–º Web Push —á–µ—Ä–µ–∑ VAPID.

–ö—Ä–∞—Ç–∫–æ:

- `job.done` ‚Üí –æ–±—ã—á–Ω–æ **WS + Push**  
- `action.required` ‚Üí **WS + Push**, –∏–Ω–æ–≥–¥–∞ Email  
- `message.new` ‚Üí **WS** + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ Push  
- `job.progress` ‚Üí **—Ç–æ–ª—å–∫–æ WS**  
- `reminder.due` ‚Üí **Push** (–∏ WS, –µ—Å–ª–∏ –æ–Ω–ª–∞–π–Ω)  
- `system.alert` ‚Üí **WS + Email**, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ Push.

---

### –ï4. –ö–∞–∫ —Ñ—Ä–æ–Ω—Ç —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏–µ

#### –ß–µ—Ä–µ–∑ WebSocket (–æ–Ω–ª–∞–π–Ω)

- `job.done` ‚Üí —Ç–æ—Å—Ç ¬´–ì–æ—Ç–æ–≤–æ¬ª + –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª (`cta.url`).  
- `action.required` ‚Üí –º–æ–¥–∞–ª–∫–∞ —Å –≤—ã–±–æ—Ä–æ–º –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.  
- `message.new` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç, –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ.  
- `reminder.due` ‚Üí –º—è–≥–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.

#### –ß–µ—Ä–µ–∑ Push (–æ—Ñ–ª–∞–π–Ω)

```js
self.addEventListener('push', event => {
  const data = event.data.json();
  self.registration.showNotification(data.title, {
    body: data.body,
    data: { url: data.cta?.url }
  });
});

self.addEventListener('notificationclick', event => {
  event.notification.close();
  event.waitUntil(
    clients.openWindow(event.notification.data.url || '/app')
  );
});
```

---

## 5. –ö–∞–∫ –æ–Ω–æ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (—Ç–∞–±–ª–∏—á–∫–∞ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º)

(–°–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π –≤–∏–¥, —Å–º–æ—Ç—Ä–∏ –ø–æ–ª–Ω—ã–π –≤ –¢–ó.)

| –°–µ—Ä–≤–∏—Å        | –ö–æ–≥–¥–∞                                        | type —Å–æ–±—ã—Ç–∏—è    | –ß—Ç–æ –≤–∏–¥–∏—Ç —á–µ–ª–æ–≤–µ–∫                                 |
|---------------|----------------------------------------------|-----------------|---------------------------------------------------|
| –ó–∞–º–µ—Ç–∫–∏       | –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤–∞–∂–Ω–æ–π –º—ã—Å–ª–∏                   | `reminder.due`  | ¬´–¢—ã —Ö–æ—Ç–µ–ª –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —ç—Ç–æ–π –∑–∞–º–µ—Ç–∫–µ¬ª               |
| –ó–∞–¥–∞—á–∏        | –ù—É–∂–µ–Ω –≤—ã–±–æ—Ä —Å—Ä–æ–∫–∞/–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞                 | `action.required` | ¬´–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥–µ–¥–ª–∞–π–Ω/–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ –∑–∞–¥–∞—á–µ¬ª     |
| –í–∏–∑–∏—è         | –í—Ä–µ–º—è —á–µ–∫-–∏–Ω–∞                               | `reminder.due`  | ¬´–ü–æ—Ä–∞ –æ–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ—é –≤–∏–∑–∏—é / –∏—Ç–æ–≥–∏ –¥–Ω—è¬ª            |
| Journey       | –ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                            | `message.new`   | ¬´–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π –≤–∏–∑–∏–∏¬ª             |
| –ó–¥–æ—Ä–æ–≤—å–µ      | –ú–∏–Ω–∏-–ø—Ä–∞–∫—Ç–∏–∫–∞                               | `reminder.due`  | ¬´–°–¥–µ–ª–∞–π –º–∏–Ω—É—Ç–Ω—É—é –ø–∞—É–∑—É: –¥—ã—Ö–∞–Ω–∏–µ / –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å¬ª   |
| –û–±—â–∏–π —á–∞—Ç     | –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ                    | `message.new`   | ¬´–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ Symbiotic Way¬ª            |
| –°–∏—Å—Ç–µ–º–Ω—ã–π     | –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã/–ø–æ–¥–ø–∏—Å–∫–∏                      | `system.alert`  | ¬´–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã/–ø–æ–¥–ø–∏—Å–∫–∏, –Ω—É–∂–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ¬ª          |

---

## 6. –ö–∞–Ω–∞–ª E-MAIL

E-–º–µ–π–ª ‚Äî –µ—â—ë –æ–¥–∏–Ω –∫–∞–Ω–∞–ª –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏—è, **–Ω–∞—Ä—è–¥—É —Å WebSocket –∏ Push**.

- –ö–∞–Ω–∞–ª –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ñ–ª–∞–≥–æ–º `channels` –≤ —Å–æ–±—ã—Ç–∏–∏ (`"email"`).  
- –ö–∞–∫ —Ç–æ–ª—å–∫–æ EventCenter —Å–æ–∑–¥–∞—ë—Ç —Å–æ–±—ã—Ç–∏–µ, –æ–Ω:
  - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ –ë–î,  
  - —à–ª—ë—Ç –ø–æ WebSocket,  
  - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî —á–µ—Ä–µ–∑ Web Push,  
  - –∏, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω –∫–∞–Ω–∞–ª `email`, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∏—Å—å–º–æ –ø–æ —à–∞–±–ª–æ–Ω—É, –∑–∞–≤—è–∑–∞–Ω–Ω–æ–º—É –Ω–∞ `type` (–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ `data.service`).

–ü—Ä–∞–≤–∏–ª–∞, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å e-mail:

- –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –≤–µ—â–∏ (–æ—Ç—á—ë—Ç—ã, –≤–∞–∂–Ω—ã–µ —à–∞–≥–∏, –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è, –æ—à–∏–±–∫–∏ –æ–ø–ª–∞—Ç—ã),  
- –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —á–µ–ª–æ–≤–µ–∫ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∑–∂–µ,  
- –¥–Ω–µ–≤–Ω—ã–µ/–Ω–µ–¥–µ–ª—å–Ω—ã–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã.  

–î–ª—è ‚Äú—à—É–º–∞‚Äù (–∫–∞–∂–¥–æ–µ —á–∞—Ç-—Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å `3‚Üí4‚Üí5‚Üí6%`) –ø–æ—á—Ç–∞ **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**.

---

## 7. –ß—Ç–æ —Ç–∞–∫–æ–µ EventCenter (–ø–æ-–ø—Ä–æ—Å—Ç–æ–º—É)

EventCenter ‚Äî —ç—Ç–æ –æ–±—â–∏–π –±–µ–∫–µ–Ω–¥-–º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π:

- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–¥–Ω–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ—Ç –ª—é–±—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤,
- —Å–∞–º —Ä–µ—à–∞–µ—Ç, –∫–∞–∫ –µ–≥–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å:
  - –ø–æ WebSocket,
  - —á–µ—Ä–µ–∑ Push,
  - –ø–æ Email (–µ—Å–ª–∏ –Ω–∞–¥–æ),
- –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å—ë –≤ –ë–î.

–°–µ—Ä–≤–∏—Å –ù–ï –¥—É–º–∞–µ—Ç –æ —Å–æ–∫–µ—Ç–∞—Ö, –ø—É—à–∞—Ö, –ø–æ—á—Ç–µ.  
–°–µ—Ä–≤–∏—Å –ø—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç:

> ¬´–£ –º–µ–Ω—è –µ—Å—Ç—å —Å–æ–±—ã—Ç–∏–µ –¥–ª—è user_id = X¬ª

–∏ –∫–∏–¥–∞–µ—Ç –µ–≥–æ –≤ EventCenter.

---

## 8. –ö–∞–∫ —Å–µ—Ä–≤–∏—Å –≤—ã–∑—ã–≤–∞–µ—Ç EventCenter (Python + FastAPI)

```python
# eventcenter/service.py
from pydantic import BaseModel
from typing import Any, Dict, List, Optional
from datetime import datetime
import uuid

from .websocket_dispatcher import send_via_websocket
from .push_dispatcher import send_via_push
from .email_dispatcher import send_via_email

class Event(BaseModel):
    id: str
    user_id: int
    type: str
    title: str
    body: str
    level: str = "info"
    channels: List[str] = ["ws"]   # ["ws"], ["ws", "push"], ["push", "email"], ...
    cta: Optional[Dict[str, Any]] = None
    data: Optional[Dict[str, Any]] = None
    created_at: datetime

async def emit_event(raw_event: Dict[str, Any]):
    """–ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞: —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–¥–∞—ë—Ç —Å—é–¥–∞ dict —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è."""

    event = Event(
        id=raw_event.get("id", f"evt_{uuid.uuid4().hex}"),
        user_id=raw_event["user_id"],
        type=raw_event["type"],
        title=raw_event["title"],
        body=raw_event["body"],
        level=raw_event.get("level", "info"),
        channels=raw_event.get("channels", ["ws"]),
        cta=raw_event.get("cta"),
        data=raw_event.get("data"),
        created_at=datetime.utcnow(),
    )

    await save_event_to_db(event)

    if "ws" in event.channels:
        await send_via_websocket(event)

    if "push" in event.channels:
        await send_via_push(event)

    if "email" in event.channels:
        await send_via_email(event)
```

### –ü—Ä–∏–º–µ—Ä: —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ ‚Äî ¬´—Ä–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞¬ª

```python
from server.eventcenter.service import emit_event

async def on_photo_job_done(user_id: int, job_id: str):
    event = {
        "user_id": user_id,
        "type": "job.done",
        "title": "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≥–æ—Ç–æ–≤–∞",
        "body": "–Ø –æ–±—Ä–∞–±–æ—Ç–∞–ª —Ç–≤–æ—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, –∑–∞–π–¥–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
        "level": "info",
        "channels": ["ws", "push", "email"],
        "cta": {
            "label": "–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ",
            "url": f"https://smart-vision.app/app/job/{job_id}"
        },
        "data": {
            "job_id": job_id,
            "service": "photo_pipeline"
        }
    }

    await emit_event(event)
```

### –ü—Ä–∏–º–µ—Ä: —Å–µ—Ä–≤–∏—Å –∑–∞–¥–∞—á ‚Äî ¬´–Ω—É–∂–Ω–æ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è¬ª

```python
from server.eventcenter.service import emit_event

async def request_user_decision(user_id: int, task_id: str, action_id: str):
    event = {
        "user_id": user_id,
        "type": "action.required",
        "title": "–ù—É–∂–Ω–æ —Ç–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ –∑–∞–¥–∞—á–µ",
        "body": "–Ø –Ω–µ –º–æ–≥—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ —Ç–≤–æ–µ–≥–æ –≤—ã–±–æ—Ä–∞. –û—Ç–∫—Ä–æ–π –∑–∞–¥–∞—á—É –∏ –≤—ã–±–µ—Ä–∏, –∫–∞–∫ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ.",
        "level": "info",
        "channels": ["ws", "push", "email"],
        "cta": {
            "label": "–û—Ç–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É",
            "url": f"https://smart-vision.app/app/tasks/{task_id}?action={action_id}"
        },
        "data": {
            "task_id": task_id,
            "action_id": action_id,
            "service": "tasks"
        }
    }

    await emit_event(event)
```

### –ü—Ä–∏–º–µ—Ä: —Å–µ—Ä–≤–∏—Å –∑–∞–º–µ—Ç–æ–∫ ‚Äî –º—è–≥–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ

```python
from server.eventcenter.service import emit_event

async def remind_about_note(user_id: int, note_id: str):
    event = {
        "user_id": user_id,
        "type": "reminder.due",
        "title": "–í–µ—Ä–Ω–∏—Å—å –∫ –≤–∞–∂–Ω–æ–π –º—ã—Å–ª–∏",
        "body": "–¢—ã –ø–æ–º–µ—Ç–∏–ª —ç—Ç—É –∑–∞–º–µ—Ç–∫—É –∫–∞–∫ –≤–∞–∂–Ω—É—é. –•–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –µ—ë —Å–µ–π—á–∞—Å?",
        "level": "info",
        "channels": ["ws", "push"],
        "cta": {
            "label": "–û—Ç–∫—Ä—ã—Ç—å –∑–∞–º–µ—Ç–∫—É",
            "url": f"https://smart-vision.app/app/notes/{note_id}"
        },
        "data": {
            "note_id": note_id,
            "service": "notes"
        }
    }

    await emit_event(event)
```

---

## 9. –û–ø–∏—Å–∞–Ω–∏–µ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π

> –ß—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ–Ω —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è (`user_id`, `type`, `title`, `body`, `channels`, `cta`, `data`) –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `EventCenter.emit(event)`. EventCenter —Å–∞–º –¥–æ—Å—Ç–∞–≤–∏—Ç —Å–æ–±—ã—Ç–∏–µ –ø–æ –Ω—É–∂–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º (WebSocket, Push, Email) –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ –≤ –∏—Å—Ç–æ—Ä–∏—é.
