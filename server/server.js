import express from 'express';
import fs from 'fs';
import path from 'path';
import { WebSocketServer } from 'ws';
import http from 'http';
import { logToFile } from './utils.js';  // Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ðº Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
const __dirname = path.dirname(new URL(import.meta.url).pathname);

const PORT = process.env.PORT || 3000;

const app = express();
const httpServer = http.createServer(app);  // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ HTTP Ð²Ð¼ÐµÑÑ‚Ð¾ HTTPS
const wss = new WebSocketServer({ server: httpServer });

const sessions = new Map();
let sessionCounter = 1;

// Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‚Ð´Ð°Ñ‡Ð° Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸Ð· Ð¿Ð°Ð¿ÐºÐ¸ smart
app.use("/smart", express.static(path.join(__dirname, "smart")));

// Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° (https://test.smartvision.life/)
app.get("/", (req, res) => {
  console.log("Request for root (/) received");
  logToFile("Request for root (/) received");
  res.sendFile(path.join(__dirname, "index.html")); // ÐžÑ‚Ð´Ð°Ñ‘Ð¼ index.html Ð¸Ð· ÐºÐ¾Ñ€Ð½Ñ
});

// Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð´Ð»Ñ /smart (https://test.smartvision.life/smart/)
app.get("/smart", (req, res) => {
  console.log("Request for /smart received");
  logToFile("Request for /smart received");
  res.sendFile(path.join(__dirname, "smart", "index.html")); // ÐžÑ‚Ð´Ð°Ñ‘Ð¼ index.html Ð¸Ð· Ð¿Ð°Ð¿ÐºÐ¸ smart
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
httpServer.listen(PORT, () => {
  logToFile(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);  // Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  console.log("ðŸŒ WebSocket Ð¸ HTTP ÑÐµÑ€Ð²ÐµÑ€Ñ‹ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹.");
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº WebSocket-ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹
wss.on("connection", (ws) => {
  ws.isAlive = true;
  ws.id = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  ws.sessionId = null;
  ws.module = null;

  ws.send("âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ðº Smart Vision WS");

  ws.on("pong", () => (ws.isAlive = true));

  ws.on("message", (msg) => {
    try {
      const data = JSON.parse(msg);
      if (data.type === "register") {
        const sessionId = `sess-${sessionCounter++}`;
        ws.sessionId = sessionId;
        sessions.set(sessionId, ws);
        ws.send(`âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾. ID ÑÐµÑÑÐ¸Ð¸: ${sessionId}`);
      } else {
        ws.send("â” ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ");
      }
    } catch (e) {
      console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:", e.message);
      logToFile(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ: ${e.message}`);  // Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
      ws.send("âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ");
    }
  });

  ws.on("close", () => {
    logToFile(`âŒ Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¾: ${ws.sessionId}`);
    sessions.delete(ws.sessionId);
  });

  ws.on("error", (err) => {
    logToFile(`âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ: ${err.message}`);
    console.warn(`âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ: ${err.message}`);
  });
});

// ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¶Ð¸Ð²Ð¾ÑÑ‚Ð¸ ÑÐµÑÑÐ¸Ð¹ (ping/pong)
setInterval(() => {
  wss.clients.forEach((ws) => {
    if (!ws.isAlive) {
      return ws.terminate();
    }
    ws.isAlive = false;
    ws.ping();
  });
}, 15000);
