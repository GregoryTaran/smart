# üìò SMART VISION ‚Äî –ë–ê–ó–ê –î–ê–ù–ù–´–• (Supabase)

---

## ‚öôÔ∏è –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —á–µ—Ç—ã—Ä—ë—Ö —Ç–∞–±–ª–∏—Ü:

- **levels** ‚Äî —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —É—Ä–æ–≤–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞  
- **users** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
- **visitor** ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ—Ä–æ–≤  
- **auth_vault** ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏  

–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π, –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ **Supabase (Postgres)**, —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ RLS (–Ω–∞ —ç—Ç–∞–ø–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è).

---

## üß© levels

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —É—Ä–æ–≤–Ω–µ–π. –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å/–∏–∑–º–µ–Ω—è—Ç—å —É—Ä–æ–≤–Ω–∏ –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π.

| –ø–æ–ª–µ | —Ç–∏–ø | –æ–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-----------|
| level_id | SMALLINT | —á–∏—Å–ª–æ–≤–æ–π ID —É—Ä–æ–≤–Ω—è |
| code | TEXT | –∫–æ–¥ —É—Ä–æ–≤–Ω—è (guest, user, paid1...) |
| name | TEXT | –∏–º—è —É—Ä–æ–≤–Ω—è |
| description | TEXT | –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è |
| is_active | BOOLEAN | –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ —É—Ä–æ–≤–µ–Ω—å |
| sort_order | SMALLINT | –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è |

**–°—Ç–∞—Ä—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:**

| id | code | name | –æ–ø–∏—Å–∞–Ω–∏–µ |
|----|------|------|----------|
| 1 | guest | Guest | –ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å |
| 2 | user | User | –ë–∞–∑–æ–≤—ã–π —é–∑–µ—Ä |
| 3 | paid1 | Paid Tier 1 | –ü–ª–∞—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å 1 |
| 4 | paid2 | Paid Tier 2 | –ü–ª–∞—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å 2 |
| 5 | super | Super User | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä |

---

## üë§ users

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ì–ª–∞–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ).  
`level` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = **2 (user)**.

| –ø–æ–ª–µ | —Ç–∏–ø | –æ–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-----------|
| user_id | UUID | —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| level | SMALLINT | FK –Ω–∞ levels(level_id), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2 |
| created_at | TIMESTAMPTZ | –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| state | ENUM(active, blocked, pending_verification, deleted) | —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—á—ë—Ç–∫–∏ |
| display_name | TEXT | –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è |
| avatar_url | TEXT | —Å—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä |
| locale | TEXT | —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ |
| timezone | TEXT | —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å |
| email | TEXT | –ø–æ—á—Ç–∞ |
| email_verified | BOOLEAN | –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –ª–∏ email |
| phone | TEXT | –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ |
| phone_verified | BOOLEAN | –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω |
| supabase_user_id | UUID | ID –≤ Supabase Auth |
| google_sub | TEXT | ID –≤ Google |
| apple_sub | TEXT | ID –≤ Apple |
| passkeys | JSONB | —Å–ø–∏—Å–æ–∫ passkey |
| plan_code | TEXT | —Ç–∞—Ä–∏—Ñ/–ø–ª–∞–Ω |
| paid_until | TIMESTAMPTZ | —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–∞—Ä–∏—Ñ–∞ |
| feature_flags | TEXT[] | –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏—á–∏ |
| limits | JSONB | –ª–∏–º–∏—Ç—ã |
| last_login_at | TIMESTAMPTZ | –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞ |
| last_ip | INET | –ø–æ—Å–ª–µ–¥–Ω–∏–π IP |
| trusted_devices | JSONB | –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ |
| linked_visitor_ids | JSONB | —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–æ—Ä—ã |
| consents | JSONB | —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| tags | TEXT[] | —Ç–µ–≥–∏ |
| notes | TEXT | –∑–∞–º–µ—Ç–∫–∏ |
| deleted_at | TIMESTAMPTZ | –¥–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è |

---

## üëÄ visitor

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ö–∞–∂–¥—ã–π –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—å (–¥–∞–∂–µ –±–µ–∑ –ª–æ–≥–∏–Ω–∞) –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `visitor_id`.  
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –≤–∏–∑–∏—Ç–æ–≤.

| –ø–æ–ª–µ | —Ç–∏–ø | –æ–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-----------|
| visitor_id | UUID | —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –≤–∏–∑–∏—Ç–æ—Ä–∞ |
| level | SMALLINT | FK levels(level_id), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 |
| first_seen_at | TIMESTAMPTZ | –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞ |
| landing_url | TEXT | –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ |
| referrer_host | TEXT | –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à—ë–ª |
| utm_source / utm_medium / utm_campaign / utm_term / utm_content | TEXT | UTM-–º–µ—Ç–∫–∏ |
| device_type | TEXT | desktop / mobile / tablet |
| device_class | TEXT | phone / tablet / desktop / tv / bot |
| device_brand / device_model | TEXT | –±—Ä–µ–Ω–¥ –∏ –º–æ–¥–µ–ª—å |
| os_name / os_version | TEXT | –û–° |
| browser_name / browser_version | TEXT | –±—Ä–∞—É–∑–µ—Ä |
| user_agent_hash | CHAR(64) | —Ö—ç—à user-agent |
| screen_width / screen_height | INTEGER | —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞ |
| touch_support | BOOLEAN | –µ—Å—Ç—å –ª–∏ —Ç–∞—á |
| app_platform | TEXT | browser / pwa / native_app / webview |
| app_name / app_version | TEXT | –∏–º—è –∏ –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| runtime_engine | TEXT | chromium / webkit / gecko / webview |
| display_mode | TEXT | browser / standalone / minimal-ui / fullscreen |
| install_source | TEXT | store / add_to_home / direct |
| geo_country / geo_city | TEXT | —Å—Ç—Ä–∞–Ω–∞ –∏ –≥–æ—Ä–æ–¥ |
| timezone_guess | TEXT | –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å |
| ip_address | INET | IP |
| linked_to_user | BOOLEAN | —Å–≤—è–∑–∞–Ω –ª–∏ —Å user |
| user_id | UUID | FK users.user_id |
| linked_at | TIMESTAMPTZ | –∫–æ–≥–¥–∞ —Å–≤—è–∑–∞–ª–∏ |
| linked_by | TEXT | —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ (login_same_device / oauth / etc.) |
| linked_visitor_ids | JSONB | –¥—Ä—É–≥–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–æ—Ä—ã |
| merge_notes | TEXT | –ø–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ —Å–ª–∏—è–Ω–∏—é |
| tags | TEXT[] | –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏ |
| notes | TEXT | –∑–∞–º–µ—Ç–∫–∏ |
| retention_ttl_days | INTEGER | —Å—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è |
| expire_at | TIMESTAMPTZ | –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –ø–æ–¥–ª–µ–∂–∏—Ç —É–¥–∞–ª–µ–Ω–∏—é |

---

## üîê auth_vault

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–•—Ä–∞–Ω–∏–ª–∏—â–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, —Ç–æ–∫–µ–Ω—ã, –∫—É–∫–∏, –ø—Ä–æ—Ñ–∏–ª–∏).  
–ü—Ä–∏–Ω—Ü–∏–ø ‚Äî **‚Äú—Ö—Ä–∞–Ω–∏–º –∫–∞–∫ –µ—Å—Ç—å‚Äù**, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞.

| –ø–æ–ª–µ | —Ç–∏–ø | –æ–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-----------|
| artifact_id | UUID | —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ |
| user_id | UUID | FK users.user_id |
| provider | TEXT | supabase / google / apple / email / otp / passkey / custom |
| kind | TEXT | session / token / cookie / claims / profile / other |
| payload | JSONB | –æ–±—ä–µ–∫—Ç, –∫–∞–∫ –ø—Ä–∏—à—ë–ª –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ |
| created_at | TIMESTAMPTZ | –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |
| status | TEXT | active / expired / revoked |
| expires_at | TIMESTAMPTZ | —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è |
| last_seen_at | TIMESTAMPTZ | –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø |
| notes | TEXT | –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |

---

## ‚öôÔ∏è –ò–Ω–¥–µ–∫—Å—ã –∏ —Å–≤—è–∑–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:**
- `users`: email, level, state, last_login_at, feature_flags (GIN)  
- `visitor`: user_id, first_seen_at, tags (GIN)  
- `auth_vault`: user_id, provider, kind  

**–°–≤—è–∑–∏:**
- `users.level ‚Üí levels.level_id`
- `visitor.level ‚Üí levels.level_id`
- `visitor.user_id ‚Üí users.user_id`
- `auth_vault.user_id ‚Üí users.user_id`

---

## üß† –õ–æ–≥–∏–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º

| —É—Ä–æ–≤–µ–Ω—å | –∫–æ–¥ | –∫—Ç–æ —ç—Ç–æ |
|----------|-----|---------|
| 1 | guest | –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤–∏–∑–∏—Ç–æ—Ä |
| 2 | user | –æ–±—ã—á–Ω—ã–π —é–∑–µ—Ä |
| 3 | paid1 | –ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ 1 |
| 4 | paid2 | –ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ 2 |
| 5 | super | –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä / —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–æ—Å—Ç—É–ø |

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —Ä–∞–±–æ—Ç–∞

1. –í Supabase –æ—Ç–∫—Ä—ã—Ç—å **SQL Editor**  
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É:
   ```bash
   001_create_levels_and_users.sql
   002_create_visitor.sql
   003_create_auth_vault.sql
   ```
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ Table Editor  
4. –ù–∞ Dev RLS **–≤—ã–∫–ª—é—á–µ–Ω**, –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ **service key**  
5. –î–ª—è —Ç–µ—Å—Ç–∞ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:
   ```sql
   INSERT INTO users (user_id, display_name, email)
   VALUES (gen_random_uuid(), 'Greg', 'greg@example.com');
   ```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- Dev: RLS **OFF**, —Ñ—Ä–æ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ backend.  
- Prod: –≤–∫–ª—é—á–∏–º RLS –ø–æ—ç—Ç–∞–ø–Ω–æ (auth_vault ‚Üí users).  
- –ù–∏–∫–∞–∫–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ ‚Äî —Ç–æ–ª—å–∫–æ JSON –∏ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø.  

---

## ‚úÖ –ò—Ç–æ–≥–æ

- 3 –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã + —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —É—Ä–æ–≤–Ω–µ–π  
- FK-—Ü–µ–ø–æ—á–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ü–µ–ª–æ—Å—Ç–Ω–∞—è  
- –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Supabase, —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ –∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏  
- JSONB –∏ GIN –ø–æ–∑–≤–æ–ª—è—é—Ç –≥–Ω—É—Ç—å –ø–æ–¥ –ª—é–±—ã–µ –∫–µ–π—Å—ã  
- –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å API —Ö–æ—Ç—å –∑–∞–≤—Ç—Ä–∞ üöÄ  



